<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Dynamic Metadata
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="F# to OpenCL compiler"/>
    <meta name="author" content="Gabriele Cocco"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/FSCL.Compiler/content/style.css" />
    <script type="text/javascript" src="/FSCL.Compiler/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/FSCLFramework/FSCL.Compiler">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/FSCL.Compiler/index.html">FSCL.Compiler</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Dynamic-Metadata" class="anchor" href="#Dynamic-Metadata">Dynamic Metadata</a></h1>

<p>Dynamic Metadata are a powerful tool based on custom attributes to drive compilation and execution behaviour in FSCL by associating meta-information to kernels and kernel parameters statically or at kernel execution time.
From the language point of view, a dynamic metadata is a custom attribute that comes along with a function to 
enable dynamic association of the information the custom attribute represents.
In this page we provide an overview on how to use dynamic metadata in FSCL programming and on the suggested approach to create your custom metadata.</p>

<h3><a name="Built-in-Dynamic-Metadata" class="anchor" href="#Built-in-Dynamic-Metadata">Built-in Dynamic Metadata</a></h3>

<p>The FSCL Compiler (and the Runtime) defines a set of built-in metadata that programmers can use to associate information to kernels and parameters.
If you took a look to <a href="kernelProgrammingTutorial.html">Kernel Programming Tutorial</a>, you already encountered a dynamic metadata (i.e. <code>AddressSpace</code>) to specify the memory space
where the OpenCL buffer corrisponding to a parameter should be allocated.</p>

<p>Another interesting built-in metadata is <code>DeviceType</code>, that allows to optimise the OpenCL code generated for a specific architecture.
This is particularly true when compiling collection functions (such as <code>Array.reduce</code>), for which the FSCL compiler is in fact able to generate different, optimised OpenCL code
for CPU devices and for GPU devices.</p>

<p>In the following example, two identical vector addition kernels are declared, the first to be optimised for Gpu execution, the second for Cpu.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span class="i">FSCL</span>
<span class="k">open</span> <span class="i">FSCL</span><span class="o">.</span><span class="i">Compiler</span>
<span class="k">open</span> <span class="i">FSCL</span><span class="o">.</span><span class="i">Language</span>

[&lt;<span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="t">ReflectedDefinition</span>; <span class="i">DeviceType</span>(<span class="i">DeviceType</span><span class="o">.</span><span class="i">Gpu</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="f">VectorAddGpu</span>(<span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs4', 6)" onmouseover="showTip(event, 'fs4', 6)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs4', 8)" onmouseover="showTip(event, 'fs4', 8)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 9)" onmouseover="showTip(event, 'fs7', 9)" class="i">wi</span><span class="o">:</span> <span class="i">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 10)" onmouseover="showTip(event, 'fs8', 10)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs7', 11)" onmouseover="showTip(event, 'fs7', 11)" class="i">wi</span><span class="o">.</span><span class="i">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs6', 12)" onmouseover="showTip(event, 'fs6', 12)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 13)" onmouseover="showTip(event, 'fs8', 13)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 14)" onmouseover="showTip(event, 'fs3', 14)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 15)" onmouseover="showTip(event, 'fs8', 15)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs5', 16)" onmouseover="showTip(event, 'fs5', 16)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 17)" onmouseover="showTip(event, 'fs8', 17)" class="i">myId</span>]

[&lt;<span onmouseout="hideTip(event, 'fs1', 18)" onmouseover="showTip(event, 'fs1', 18)" class="t">ReflectedDefinition</span>; <span class="i">DeviceType</span>(<span class="i">DeviceType</span><span class="o">.</span><span class="i">Cpu</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs9', 19)" onmouseover="showTip(event, 'fs9', 19)" class="f">VectorAddCpu</span>(<span onmouseout="hideTip(event, 'fs3', 20)" onmouseover="showTip(event, 'fs3', 20)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs4', 21)" onmouseover="showTip(event, 'fs4', 21)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs5', 22)" onmouseover="showTip(event, 'fs5', 22)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs4', 23)" onmouseover="showTip(event, 'fs4', 23)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 24)" onmouseover="showTip(event, 'fs6', 24)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs4', 25)" onmouseover="showTip(event, 'fs4', 25)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 26)" onmouseover="showTip(event, 'fs7', 26)" class="i">wi</span><span class="o">:</span> <span class="i">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 27)" onmouseover="showTip(event, 'fs8', 27)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs7', 28)" onmouseover="showTip(event, 'fs7', 28)" class="i">wi</span><span class="o">.</span><span class="i">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs6', 29)" onmouseover="showTip(event, 'fs6', 29)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 30)" onmouseover="showTip(event, 'fs8', 30)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 31)" onmouseover="showTip(event, 'fs3', 31)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 32)" onmouseover="showTip(event, 'fs8', 32)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs5', 33)" onmouseover="showTip(event, 'fs5', 33)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 34)" onmouseover="showTip(event, 'fs8', 34)" class="i">myId</span>]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs10', 35)" onmouseover="showTip(event, 'fs10', 35)" class="i">compiler</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Compiler</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs11', 36)" onmouseover="showTip(event, 'fs11', 36)" class="i">compilationResultForGpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs10', 37)" onmouseover="showTip(event, 'fs10', 37)" class="i">compiler</span><span class="o">.</span><span class="i">Compile</span>(&lt;@ <span onmouseout="hideTip(event, 'fs2', 38)" onmouseover="showTip(event, 'fs2', 38)" class="i">VectorAddGpu</span> @&gt;)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs12', 39)" onmouseover="showTip(event, 'fs12', 39)" class="i">compilationResultForCpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs10', 40)" onmouseover="showTip(event, 'fs10', 40)" class="i">compiler</span><span class="o">.</span><span class="i">Compile</span>(&lt;@ <span onmouseout="hideTip(event, 'fs9', 41)" onmouseover="showTip(event, 'fs9', 41)" class="i">VectorAddCpu</span> @&gt;)
</code></pre></td>
</tr>
</table>

<p>In the example above we needed to define vector addition twice just to associate different instances of the <code>DeviceType</code> custom attribute to each of them.
That's why every dynamic metadata requires to define a function together with a custom attribute. In this particular case, the FSCL Compiler object model exposes
both a <code>DeviceType</code> custom attribute and a <code>DEVICE_TYPE</code> function (uppercase is suggested to distinguish dynamic metadata function from other functions used inside quotations)
that can be used at kernel compilation time.
Using this function we can define vector addition only once and produce optimised code for different devices by wrapping the kernel reference or call inside it when creating the quoted expression.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">[&lt;<span onmouseout="hideTip(event, 'fs1', 42)" onmouseover="showTip(event, 'fs1', 42)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs13', 43)" onmouseover="showTip(event, 'fs13', 43)" class="f">VectorAdd</span>(<span onmouseout="hideTip(event, 'fs3', 44)" onmouseover="showTip(event, 'fs3', 44)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs4', 45)" onmouseover="showTip(event, 'fs4', 45)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs5', 46)" onmouseover="showTip(event, 'fs5', 46)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs4', 47)" onmouseover="showTip(event, 'fs4', 47)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 48)" onmouseover="showTip(event, 'fs6', 48)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs4', 49)" onmouseover="showTip(event, 'fs4', 49)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 50)" onmouseover="showTip(event, 'fs7', 50)" class="i">wi</span><span class="o">:</span> <span class="i">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 51)" onmouseover="showTip(event, 'fs8', 51)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs7', 52)" onmouseover="showTip(event, 'fs7', 52)" class="i">wi</span><span class="o">.</span><span class="i">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs6', 53)" onmouseover="showTip(event, 'fs6', 53)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 54)" onmouseover="showTip(event, 'fs8', 54)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 55)" onmouseover="showTip(event, 'fs3', 55)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 56)" onmouseover="showTip(event, 'fs8', 56)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs5', 57)" onmouseover="showTip(event, 'fs5', 57)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs8', 58)" onmouseover="showTip(event, 'fs8', 58)" class="i">myId</span>]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs10', 59)" onmouseover="showTip(event, 'fs10', 59)" class="i">compiler</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Compiler</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs11', 60)" onmouseover="showTip(event, 'fs11', 60)" class="i">compilationResultForGpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs10', 61)" onmouseover="showTip(event, 'fs10', 61)" class="i">compiler</span><span class="o">.</span><span class="i">Compile</span>(&lt;@ <span class="i">DEVICE_TYPE</span>(
                                                        <span class="i">DeviceType</span><span class="o">.</span><span class="i">Gpu</span>, 
                                                        <span onmouseout="hideTip(event, 'fs13', 62)" onmouseover="showTip(event, 'fs13', 62)" class="i">VectorAdd</span> 
                                               ) @&gt;)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs11', 63)" onmouseover="showTip(event, 'fs11', 63)" class="i">compilationResultForGpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs10', 64)" onmouseover="showTip(event, 'fs10', 64)" class="i">compiler</span><span class="o">.</span><span class="i">Compile</span>(&lt;@ <span class="i">DEVICE_TYPE</span>(
                                                        <span class="i">DeviceType</span><span class="o">.</span><span class="i">Cpu</span>, 
                                                        <span onmouseout="hideTip(event, 'fs13', 65)" onmouseover="showTip(event, 'fs13', 65)" class="i">VectorAdd</span>
                                               ) @&gt;)
</code></pre></td>
</tr>
</table>

<h3><a name="Defining-Custom-Metadata" class="anchor" href="#Defining-Custom-Metadata">Defining Custom Metadata</a></h3>

<p>Whenever you develop a custom compiler or runtime step (see <a href="compilerCustomisationTutorial.html">Compiler Customisation Tutorial</a>) that may act differently depending on some user hints, I suggest to leverage on a custom metadata to encode that hint or suggestion that the user can give you.
Defining custom metadata is really easy, there are only two things you need to do:</p>

<ul>
<li><p>Define your new metadata subclassing <code>KernelMetadataAttribute</code> or <code>ParameterMetadataAttribute</code>: 
the first is the base class of all the metadata that can be associated to kernels, while the second is the base class
of all the metadata associated to kernel parameters or kernel return values.</p></li>
<li><p>Define a function that enables to specify the metadata value dynamically, that is whenever you execute a kernel. 
Mark this function with the attribute <code>KernelMetadataFunction(type)</code>, <code>ParameterMetadataFunction(type)</code> or <code>ReturnMetadataFunction(type)</code>,
depending on the target you have planned for your custom metadata.</p></li>
</ul>

<p>Let's show an example. Assume we developed a compiler step processor that "flatten" vector types (such as <code>float4</code>, <code>int3</code>, <code>uint8</code>) 
into the corresponding scalar types.
We want to enable the programmer to decide whether to flatten a kernel parameter or not. 
Since FSCL kernels can return arrays we should also provide a way to tell the compiler step to flatten returned arrays (if they contain values of some vector type).</p>

<h3><a name="Define-dynamic-metadata-attribute" class="anchor" href="#Define-dynamic-metadata-attribute">Define dynamic metadata attribute</a></h3>

<p>The first step is to define a custom attribute to statically mark kernel paramters and return type.
The only important thing to remember is to always give your custom meta a default constructor. 
In fact, whenever we define a custom parameter metadata (but the same holds for kernel metadata), every possible kernel parameter 
will have an instance of that metadata associated. 
If the programmer does not associate any instance of our metadata to a kernel parameter, the parameter will still hold a value for that metadata, which is obtained by invoking its default constructor.
In other words, if a programmer does not specify a particular parameter meta, it is exactly like he was instantiating that meta using the default constructor.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs14', 66)" onmouseover="showTip(event, 'fs14', 66)" class="t">DevectorizeAttribute</span>(<span onmouseout="hideTip(event, 'fs15', 67)" onmouseover="showTip(event, 'fs15', 67)" class="i">enable</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs16', 68)" onmouseover="showTip(event, 'fs16', 68)" class="t">bool</span>) <span class="o">=</span>
    <span class="k">inherit</span> <span class="i">ParameterMetadataAttribute</span>()
    <span class="k">member</span> <span class="k">val</span> <span onmouseout="hideTip(event, 'fs17', 69)" onmouseover="showTip(event, 'fs17', 69)" class="i">Enable</span> <span class="o">=</span> <span class="i">enable</span> <span class="k">with</span> <span class="i">get</span>
    <span class="k">new</span>() <span class="o">=</span>
        <span onmouseout="hideTip(event, 'fs14', 70)" onmouseover="showTip(event, 'fs14', 70)" class="i">DevectorizeAttribute</span>(<span class="k">false</span>)
</code></pre></td>
</tr>
</table>

<h3><a name="Define-metadata-function" class="anchor" href="#Define-metadata-function">Define metadata function</a></h3>

<p>If we want to enable programmers to dynamically provide a value for your meta when a particular instance of the kernel is executed (i.e. inside quotations), 
we need to define a function that "emulates" the .NET custom attribute in a dynamic context.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">[&lt;<span class="i">ParameterMetadataFunction</span>(<span onmouseout="hideTip(event, 'fs18', 71)" onmouseover="showTip(event, 'fs18', 71)" class="i">typeof</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs14', 72)" onmouseover="showTip(event, 'fs14', 72)" class="i">DevectorizeAttribute</span><span class="o">&gt;</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs19', 73)" onmouseover="showTip(event, 'fs19', 73)" class="f">DEVECTORIZE</span>(<span onmouseout="hideTip(event, 'fs15', 74)" onmouseover="showTip(event, 'fs15', 74)" class="i">enable</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs16', 75)" onmouseover="showTip(event, 'fs16', 75)" class="t">bool</span>, <span onmouseout="hideTip(event, 'fs20', 76)" onmouseover="showTip(event, 'fs20', 76)" class="i">a</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs20', 77)" onmouseover="showTip(event, 'fs20', 77)" class="i">a</span>

[&lt;<span class="i">ReturnMetadataFunction</span>(<span onmouseout="hideTip(event, 'fs18', 78)" onmouseover="showTip(event, 'fs18', 78)" class="i">typeof</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs14', 79)" onmouseover="showTip(event, 'fs14', 79)" class="i">DevectorizeAttribute</span><span class="o">&gt;</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs21', 80)" onmouseover="showTip(event, 'fs21', 80)" class="f">DEVECTORIZE_RETURN</span>(<span onmouseout="hideTip(event, 'fs15', 81)" onmouseover="showTip(event, 'fs15', 81)" class="i">enable</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs16', 82)" onmouseover="showTip(event, 'fs16', 82)" class="t">bool</span>, <span onmouseout="hideTip(event, 'fs20', 83)" onmouseover="showTip(event, 'fs20', 83)" class="i">a</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs20', 84)" onmouseover="showTip(event, 'fs20', 84)" class="i">a</span> 
</code></pre></td>
</tr>
</table>

<p>Since the metadata can be associated to both parameters and return values, two distinct functions are requires. 
This is (unfortunately) required to enable FSCL to distinguish whether a metadata is associated to a parameter or to the return value when the metadata function wraps a subkernel, 
that is a kernel passed as parameter to another kernel.</p>

<h3><a name="Employing-metadata-in-kernel-programming" class="anchor" href="#Employing-metadata-in-kernel-programming">Employing metadata in kernel programming</a></h3>

<p>Once define a custom metadata attribute and a matching metadata function, 
programmers can mark parameters and return types in kernel definitions as well as actual arguments an return values in kernel calls.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// Static metadata are associated to kernel definition</span>
[&lt;<span onmouseout="hideTip(event, 'fs14', 85)" onmouseover="showTip(event, 'fs14', 85)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] 
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs22', 86)" onmouseover="showTip(event, 'fs22', 86)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs23', 87)" onmouseover="showTip(event, 'fs23', 87)" class="i">a</span><span class="o">:</span> <span class="i">float4</span>[], 
             [&lt;<span onmouseout="hideTip(event, 'fs14', 88)" onmouseover="showTip(event, 'fs14', 88)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] 
             <span onmouseout="hideTip(event, 'fs24', 89)" onmouseover="showTip(event, 'fs24', 89)" class="i">b</span><span class="o">:</span> <span class="i">float4</span>[], 
             <span onmouseout="hideTip(event, 'fs25', 90)" onmouseover="showTip(event, 'fs25', 90)" class="i">c</span><span class="o">:</span> <span class="i">float4</span>[]) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs26', 91)" onmouseover="showTip(event, 'fs26', 91)" class="i">d</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 92)" onmouseover="showTip(event, 'fs27', 92)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 93)" onmouseover="showTip(event, 'fs28', 93)" class="f">zeroCreate</span><span class="o">&lt;</span><span class="i">float4</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs23', 94)" onmouseover="showTip(event, 'fs23', 94)" class="i">a</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 95)" onmouseover="showTip(event, 'fs29', 95)" class="i">Length</span>
    <span class="c">// ...</span>
    <span onmouseout="hideTip(event, 'fs26', 96)" onmouseover="showTip(event, 'fs26', 96)" class="i">d</span>
    
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs30', 97)" onmouseover="showTip(event, 'fs30', 97)" class="i">a</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 98)" onmouseover="showTip(event, 'fs27', 98)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 99)" onmouseover="showTip(event, 'fs31', 99)" class="f">create</span> <span class="n">1024</span> (<span class="i">float4</span>(<span class="n">0.0f</span>))
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs32', 100)" onmouseover="showTip(event, 'fs32', 100)" class="i">b</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 101)" onmouseover="showTip(event, 'fs27', 101)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 102)" onmouseover="showTip(event, 'fs31', 102)" class="f">create</span> <span class="n">1024</span> (<span class="i">float4</span>(<span class="n">0.0f</span>))
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs33', 103)" onmouseover="showTip(event, 'fs33', 103)" class="i">c</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 104)" onmouseover="showTip(event, 'fs27', 104)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 105)" onmouseover="showTip(event, 'fs28', 105)" class="f">zeroCreate</span><span class="o">&lt;</span><span class="i">float4</span><span class="o">&gt;</span> <span class="n">1024</span>

<span class="c">// Dynamic metadata functions override static metadata in kernel execution</span>
<span class="c">// Override return</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs34', 106)" onmouseover="showTip(event, 'fs34', 106)" class="i">overrideReturn</span> <span class="o">=</span> &lt;@ <span onmouseout="hideTip(event, 'fs21', 107)" onmouseover="showTip(event, 'fs21', 107)" class="f">DEVECTORIZE_RETURN</span>(<span class="k">false</span>, <span onmouseout="hideTip(event, 'fs22', 108)" onmouseover="showTip(event, 'fs22', 108)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs30', 109)" onmouseover="showTip(event, 'fs30', 109)" class="i">a</span>, <span onmouseout="hideTip(event, 'fs32', 110)" onmouseover="showTip(event, 'fs32', 110)" class="i">b</span>, <span onmouseout="hideTip(event, 'fs33', 111)" onmouseover="showTip(event, 'fs33', 111)" class="i">c</span>)) @&gt;

<span class="c">// Override devectorize metadata value for b</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs35', 112)" onmouseover="showTip(event, 'fs35', 112)" class="i">overrideB</span> <span class="o">=</span> &lt;@ <span onmouseout="hideTip(event, 'fs22', 113)" onmouseover="showTip(event, 'fs22', 113)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs30', 114)" onmouseover="showTip(event, 'fs30', 114)" class="i">a</span>, <span onmouseout="hideTip(event, 'fs19', 115)" onmouseover="showTip(event, 'fs19', 115)" class="f">DEVECTORIZE</span>(<span class="k">false</span>, <span onmouseout="hideTip(event, 'fs32', 116)" onmouseover="showTip(event, 'fs32', 116)" class="i">b</span>), <span onmouseout="hideTip(event, 'fs33', 117)" onmouseover="showTip(event, 'fs33', 117)" class="i">c</span>) @&gt;
</code></pre></td>
</tr>
</table>

<p>Remember that if programmers do not specify any devectorize metadata value for a parameter or return value, 
it is exactly like they specified the default value.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// This one...</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs22', 118)" onmouseover="showTip(event, 'fs22', 118)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs23', 119)" onmouseover="showTip(event, 'fs23', 119)" class="i">a</span><span class="o">:</span> <span class="i">float4</span>[], 
             [&lt;<span onmouseout="hideTip(event, 'fs14', 120)" onmouseover="showTip(event, 'fs14', 120)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] 
             <span onmouseout="hideTip(event, 'fs24', 121)" onmouseover="showTip(event, 'fs24', 121)" class="i">b</span><span class="o">:</span> <span class="i">float4</span>[], 
             <span onmouseout="hideTip(event, 'fs25', 122)" onmouseover="showTip(event, 'fs25', 122)" class="i">c</span><span class="o">:</span> <span class="i">float4</span>[]) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs26', 123)" onmouseover="showTip(event, 'fs26', 123)" class="i">d</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 124)" onmouseover="showTip(event, 'fs27', 124)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 125)" onmouseover="showTip(event, 'fs28', 125)" class="f">zeroCreate</span><span class="o">&lt;</span><span class="i">float4</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs23', 126)" onmouseover="showTip(event, 'fs23', 126)" class="i">a</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 127)" onmouseover="showTip(event, 'fs29', 127)" class="i">Length</span>
    <span class="c">// ...</span>
    <span onmouseout="hideTip(event, 'fs26', 128)" onmouseover="showTip(event, 'fs26', 128)" class="i">d</span>

<span class="c">// ...is equivalent to (since default constructor assigns &quot;false&quot; to DevectorizeAttribute &quot;Enable&quot; property) </span>
[&lt;<span onmouseout="hideTip(event, 'fs14', 129)" onmouseover="showTip(event, 'fs14', 129)" class="t">Devectorize</span>(<span class="k">false</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs22', 130)" onmouseover="showTip(event, 'fs22', 130)" class="f">MyKernel</span>([&lt;<span onmouseout="hideTip(event, 'fs14', 131)" onmouseover="showTip(event, 'fs14', 131)" class="t">Devectorize</span>(<span class="k">false</span>)&gt;] <span onmouseout="hideTip(event, 'fs23', 132)" onmouseover="showTip(event, 'fs23', 132)" class="i">a</span><span class="o">:</span> <span class="i">float4</span>[],
             [&lt;<span onmouseout="hideTip(event, 'fs14', 133)" onmouseover="showTip(event, 'fs14', 133)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] <span onmouseout="hideTip(event, 'fs24', 134)" onmouseover="showTip(event, 'fs24', 134)" class="i">b</span><span class="o">:</span> <span class="i">float4</span>[], 
             [&lt;<span onmouseout="hideTip(event, 'fs14', 135)" onmouseover="showTip(event, 'fs14', 135)" class="t">Devectorize</span>(<span class="k">false</span>)&gt;] <span onmouseout="hideTip(event, 'fs25', 136)" onmouseover="showTip(event, 'fs25', 136)" class="i">c</span><span class="o">:</span> <span class="i">float4</span>[]) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs26', 137)" onmouseover="showTip(event, 'fs26', 137)" class="i">d</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 138)" onmouseover="showTip(event, 'fs27', 138)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 139)" onmouseover="showTip(event, 'fs28', 139)" class="f">zeroCreate</span><span class="o">&lt;</span><span class="i">float4</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs23', 140)" onmouseover="showTip(event, 'fs23', 140)" class="i">a</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 141)" onmouseover="showTip(event, 'fs29', 141)" class="i">Length</span>
    <span class="c">// ...</span>
    <span onmouseout="hideTip(event, 'fs26', 142)" onmouseover="showTip(event, 'fs26', 142)" class="i">d</span>
</code></pre></td>
</tr>
</table>

<div class="tip" id="fs1">Multiple items<br />type ReflectedDefinitionAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : unit -&gt; ReflectedDefinitionAttribute<br /><br />Full name: Microsoft.FSharp.Core.ReflectedDefinitionAttribute<br /><br />--------------------<br />new : unit -&gt; ReflectedDefinitionAttribute</div>
<div class="tip" id="fs2">val VectorAddGpu : a:float32 [] * b:float32 [] * c:float32 [] * wi:&#39;a -&gt; unit<br /><br />Full name: DynamicMetadataTutorial.VectorAddGpu</div>
<div class="tip" id="fs3">val a : float32 []</div>
<div class="tip" id="fs4">Multiple items<br />val float32 : value:&#39;T -&gt; float32 (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.float32<br /><br />--------------------<br />type float32 = System.Single<br /><br />Full name: Microsoft.FSharp.Core.float32<br /><br />--------------------<br />type float32&lt;&#39;Measure&gt; = float32<br /><br />Full name: Microsoft.FSharp.Core.float32&lt;_&gt;</div>
<div class="tip" id="fs5">val b : float32 []</div>
<div class="tip" id="fs6">val c : float32 []</div>
<div class="tip" id="fs7">val wi : &#39;a</div>
<div class="tip" id="fs8">val myId : int</div>
<div class="tip" id="fs9">val VectorAddCpu : a:float32 [] * b:float32 [] * c:float32 [] * wi:&#39;a -&gt; unit<br /><br />Full name: DynamicMetadataTutorial.VectorAddCpu</div>
<div class="tip" id="fs10">val compiler : obj<br /><br />Full name: DynamicMetadataTutorial.compiler</div>
<div class="tip" id="fs11">val compilationResultForGpu : obj<br /><br />Full name: DynamicMetadataTutorial.compilationResultForGpu</div>
<div class="tip" id="fs12">val compilationResultForCpu : obj<br /><br />Full name: DynamicMetadataTutorial.compilationResultForCpu</div>
<div class="tip" id="fs13">val VectorAdd : a:float32 [] * b:float32 [] * c:float32 [] * wi:&#39;a -&gt; unit<br /><br />Full name: DynamicMetadataTutorial.VectorAdd</div>
<div class="tip" id="fs14">Multiple items<br />type DevectorizeAttribute =<br />&#160;&#160;inherit obj<br />&#160;&#160;new : unit -&gt; DevectorizeAttribute<br />&#160;&#160;new : enable:bool -&gt; DevectorizeAttribute<br />&#160;&#160;member Enable : &#39;a<br /><br />Full name: DynamicMetadataTutorial.DevectorizeAttribute<br /><br />--------------------<br />new : unit -&gt; DevectorizeAttribute<br />new : enable:bool -&gt; DevectorizeAttribute</div>
<div class="tip" id="fs15">val enable : bool</div>
<div class="tip" id="fs16">type bool = System.Boolean<br /><br />Full name: Microsoft.FSharp.Core.bool</div>
<div class="tip" id="fs17">member DevectorizeAttribute.Enable : &#39;a<br /><br />Full name: DynamicMetadataTutorial.DevectorizeAttribute.Enable</div>
<div class="tip" id="fs18">val typeof&lt;&#39;T&gt; : System.Type<br /><br />Full name: Microsoft.FSharp.Core.Operators.typeof</div>
<div class="tip" id="fs19">val DEVECTORIZE : enable:bool * a:&#39;a -&gt; &#39;a<br /><br />Full name: DynamicMetadataTutorial.DEVECTORIZE</div>
<div class="tip" id="fs20">val a : &#39;a</div>
<div class="tip" id="fs21">val DEVECTORIZE_RETURN : enable:bool * a:&#39;a -&gt; &#39;a<br /><br />Full name: DynamicMetadataTutorial.DEVECTORIZE_RETURN</div>
<div class="tip" id="fs22">val MyKernel : a:&#39;a [] * b:&#39;b [] * c:&#39;c [] -&gt; &#39;d<br /><br />Full name: DynamicMetadataTutorial.MyKernel</div>
<div class="tip" id="fs23">val a : &#39;a []</div>
<div class="tip" id="fs24">val b : &#39;b []</div>
<div class="tip" id="fs25">val c : &#39;c []</div>
<div class="tip" id="fs26">val d : &#39;d</div>
<div class="tip" id="fs27">module Array<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs28">val zeroCreate : count:int -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.zeroCreate</div>
<div class="tip" id="fs29">property System.Array.Length: int</div>
<div class="tip" id="fs30">val a : obj []<br /><br />Full name: DynamicMetadataTutorial.a</div>
<div class="tip" id="fs31">val create : count:int -&gt; value:&#39;T -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.create</div>
<div class="tip" id="fs32">val b : obj []<br /><br />Full name: DynamicMetadataTutorial.b</div>
<div class="tip" id="fs33">val c : obj []<br /><br />Full name: DynamicMetadataTutorial.c</div>
<div class="tip" id="fs34">val overrideReturn : Quotations.Expr&lt;obj&gt;<br /><br />Full name: DynamicMetadataTutorial.overrideReturn</div>
<div class="tip" id="fs35">val overrideB : Quotations.Expr&lt;obj&gt;<br /><br />Full name: DynamicMetadataTutorial.overrideB</div>

        </div>
        <div class="span3">
          <img src="/FSCL.Compiler/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">FSCL.Compiler</li>
            <li><a href="/FSCL.Compiler/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/FSCL.Compiler">Get Library via NuGet</a></li>
            <li><a href="http://github.com/FSCLFramework/FSCL.Compiler">Source Code on GitHub</a></li>
            <li><a href="/FSCL.Compiler/license.html">License</a></li>
            <li><a href="/FSCL.Compiler/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/FSCL.Compiler/tutorial.html">Sample tutorial</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="/FSCL.Compiler/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/FSCLFramework/FSCL.Compiler"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
