<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Dynamic Metadata
</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="F# to OpenCL compiler" />
    <meta name="author" content="Gabriele Cocco" />
    <script type="text/javascript" src="javascripts/jquery-1.11.1.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("table.pre").wrap("<div class='code-container'></div>");
            $("table.pre").css("width", ($("section").width() - 30) + "px");
            $("pre.fssnip").css("width", ($("section").width() - 30) + "px");
            $(window).resize(function () {
                $("table.pre").css("width", ($("section").width() - 30) + "px");
                $("pre.fssnip").css("width", ($("section").width() - 30) + "px");
            });
        });
    </script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <div class="wrapper">
        <header>
            <div class="header-container">
                <h1><a href="/FSCL.Compiler">FSCL.Compiler</a></h1>
                <p>F# to OpenCL compiler</p>
            </div>
            <table class="git-links">
                <tr>
                    <td><a href="https://github.com/FSCL/FSCL.Runtime/zipball/master">Download <strong>ZIP File</strong></a></td>
                    <td><a href="https://github.com/FSCL/FSCL.Runtime/tarball/master">Download <strong>TAR Ball</strong></a></td>
                    <td><a href="http://github.com/FSCL/FSCL.Runtime/master">Fork On <strong>GitHub</strong></a></td>
                </tr>
            </table>
        </header>
        <section>
            
<h1><a name="Dynamic-Metadata" class="anchor" href="#Dynamic-Metadata">Dynamic Metadata</a></h1>

<p>Dynamic Metadata are a powerful tool based on custom attributes to drive compilation and execution behaviour in FSCL by associating meta-information to kernels and kernel parameters statically or at kernel execution time.
From the language point of view, a dynamic metadata is a custom attribute that comes along with a function to 
enable dynamic association of the information the custom attribute represents.
In this page we provide an overview on how to use dynamic metadata in FSCL programming and on the suggested approach to create your custom metadata.</p>

<h3><a name="Built-in-Dynamic-Metadata" class="anchor" href="#Built-in-Dynamic-Metadata">Built-in Dynamic Metadata</a></h3>

<p>The FSCL Compiler (and the Runtime) defines a set of built-in metadata that programmers can use to associate information to kernels and parameters.
If you took a look to <a href="kernelProgrammingTutorial.html">Kernel Programming Tutorial</a>, you already encountered a dynamic metadata (i.e. <code>AddressSpace</code>) to specify the memory space
where the OpenCL buffer corrisponding to a parameter should be allocated.</p>

<p>Another interesting built-in metadata is <code>DeviceType</code>, that allows to optimise the OpenCL code generated for a specific architecture.
This is particularly true when compiling collection functions (such as <code>Array.reduce</code>), for which the FSCL compiler is in fact able to generate different, optimised OpenCL code
for CPU devices and for GPU devices.</p>

<p>In the following example, two identical vector addition kernels are declared, the first to be optimised for Gpu execution, the second for Cpu.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">FSCL</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 2)" onmouseover="showTip(event, 'fs1', 2)" class="i">FSCL</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">Compiler</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="i">FSCL</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="i">Language</span>

[&lt;<span onmouseout="hideTip(event, 'fs3', 6)" onmouseover="showTip(event, 'fs3', 6)" class="t">ReflectedDefinition</span>; <span onmouseout="hideTip(event, 'fs3', 7)" onmouseover="showTip(event, 'fs3', 7)" class="t">DeviceType</span>(<span onmouseout="hideTip(event, 'fs3', 8)" onmouseover="showTip(event, 'fs3', 8)" class="t">DeviceType</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs5', 9)" onmouseover="showTip(event, 'fs5', 9)" class="i">Gpu</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 10)" onmouseover="showTip(event, 'fs3', 10)" class="f">VectorAddGpu</span>(<span onmouseout="hideTip(event, 'fs6', 11)" onmouseover="showTip(event, 'fs6', 11)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 12)" onmouseover="showTip(event, 'fs3', 12)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 13)" onmouseover="showTip(event, 'fs7', 13)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 14)" onmouseover="showTip(event, 'fs3', 14)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs8', 15)" onmouseover="showTip(event, 'fs8', 15)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 16)" onmouseover="showTip(event, 'fs3', 16)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 17)" onmouseover="showTip(event, 'fs3', 17)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 18)" onmouseover="showTip(event, 'fs3', 18)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 19)" onmouseover="showTip(event, 'fs3', 19)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 20)" onmouseover="showTip(event, 'fs3', 20)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs9', 21)" onmouseover="showTip(event, 'fs9', 21)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs8', 22)" onmouseover="showTip(event, 'fs8', 22)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 23)" onmouseover="showTip(event, 'fs3', 23)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs6', 24)" onmouseover="showTip(event, 'fs6', 24)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 25)" onmouseover="showTip(event, 'fs3', 25)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs7', 26)" onmouseover="showTip(event, 'fs7', 26)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 27)" onmouseover="showTip(event, 'fs3', 27)" class="i">myId</span>]

[&lt;<span onmouseout="hideTip(event, 'fs3', 28)" onmouseover="showTip(event, 'fs3', 28)" class="t">ReflectedDefinition</span>; <span onmouseout="hideTip(event, 'fs3', 29)" onmouseover="showTip(event, 'fs3', 29)" class="t">DeviceType</span>(<span onmouseout="hideTip(event, 'fs3', 30)" onmouseover="showTip(event, 'fs3', 30)" class="t">DeviceType</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 31)" onmouseover="showTip(event, 'fs10', 31)" class="i">Cpu</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 32)" onmouseover="showTip(event, 'fs3', 32)" class="f">VectorAddCpu</span>(<span onmouseout="hideTip(event, 'fs6', 33)" onmouseover="showTip(event, 'fs6', 33)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 34)" onmouseover="showTip(event, 'fs3', 34)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 35)" onmouseover="showTip(event, 'fs7', 35)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 36)" onmouseover="showTip(event, 'fs3', 36)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs8', 37)" onmouseover="showTip(event, 'fs8', 37)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 38)" onmouseover="showTip(event, 'fs3', 38)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 39)" onmouseover="showTip(event, 'fs3', 39)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 40)" onmouseover="showTip(event, 'fs3', 40)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 41)" onmouseover="showTip(event, 'fs3', 41)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 42)" onmouseover="showTip(event, 'fs3', 42)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs9', 43)" onmouseover="showTip(event, 'fs9', 43)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs8', 44)" onmouseover="showTip(event, 'fs8', 44)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 45)" onmouseover="showTip(event, 'fs3', 45)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs6', 46)" onmouseover="showTip(event, 'fs6', 46)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 47)" onmouseover="showTip(event, 'fs3', 47)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs7', 48)" onmouseover="showTip(event, 'fs7', 48)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 49)" onmouseover="showTip(event, 'fs3', 49)" class="i">myId</span>]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 50)" onmouseover="showTip(event, 'fs3', 50)" class="i">compiler</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs3', 51)" onmouseover="showTip(event, 'fs3', 51)" class="t">Compiler</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 52)" onmouseover="showTip(event, 'fs3', 52)" class="i">compilationResultForGpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 53)" onmouseover="showTip(event, 'fs3', 53)" class="i">compiler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 54)" onmouseover="showTip(event, 'fs3', 54)" class="i">Compile</span>(&lt;@ <span onmouseout="hideTip(event, 'fs3', 55)" onmouseover="showTip(event, 'fs3', 55)" class="i">VectorAddGpu</span> @&gt;)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 56)" onmouseover="showTip(event, 'fs3', 56)" class="i">compilationResultForCpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 57)" onmouseover="showTip(event, 'fs3', 57)" class="i">compiler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 58)" onmouseover="showTip(event, 'fs3', 58)" class="i">Compile</span>(&lt;@ <span onmouseout="hideTip(event, 'fs3', 59)" onmouseover="showTip(event, 'fs3', 59)" class="i">VectorAddCpu</span> @&gt;)
</pre>
</td>
</tr>
</table>

<p>In the example above we needed to define vector addition twice just to associate different instances of the <code>DeviceType</code> custom attribute to each of them.
That's why every dynamic metadata requires to define a function together with a custom attribute. In this particular case, the FSCL Compiler object model exposes
both a <code>DeviceType</code> custom attribute and a <code>DEVICE_TYPE</code> function (uppercase is suggested to distinguish dynamic metadata function from other functions used inside quotations)
that can be used at kernel compilation time.
Using this function we can define vector addition only once and produce optimised code for different devices by wrapping the kernel reference or call inside it when creating the quoted expression.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 60)" onmouseover="showTip(event, 'fs3', 60)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 61)" onmouseover="showTip(event, 'fs3', 61)" class="f">VectorAdd</span>(<span onmouseout="hideTip(event, 'fs6', 62)" onmouseover="showTip(event, 'fs6', 62)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 63)" onmouseover="showTip(event, 'fs3', 63)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 64)" onmouseover="showTip(event, 'fs7', 64)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 65)" onmouseover="showTip(event, 'fs3', 65)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs8', 66)" onmouseover="showTip(event, 'fs8', 66)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 67)" onmouseover="showTip(event, 'fs3', 67)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 68)" onmouseover="showTip(event, 'fs3', 68)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 69)" onmouseover="showTip(event, 'fs3', 69)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 70)" onmouseover="showTip(event, 'fs3', 70)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 71)" onmouseover="showTip(event, 'fs3', 71)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs9', 72)" onmouseover="showTip(event, 'fs9', 72)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs8', 73)" onmouseover="showTip(event, 'fs8', 73)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 74)" onmouseover="showTip(event, 'fs3', 74)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs6', 75)" onmouseover="showTip(event, 'fs6', 75)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 76)" onmouseover="showTip(event, 'fs3', 76)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs7', 77)" onmouseover="showTip(event, 'fs7', 77)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 78)" onmouseover="showTip(event, 'fs3', 78)" class="i">myId</span>]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 79)" onmouseover="showTip(event, 'fs3', 79)" class="i">compiler</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs3', 80)" onmouseover="showTip(event, 'fs3', 80)" class="t">Compiler</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 81)" onmouseover="showTip(event, 'fs3', 81)" class="i">compilationResultForGpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 82)" onmouseover="showTip(event, 'fs3', 82)" class="i">compiler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 83)" onmouseover="showTip(event, 'fs3', 83)" class="i">Compile</span>(&lt;@ <span onmouseout="hideTip(event, 'fs3', 84)" onmouseover="showTip(event, 'fs3', 84)" class="i">DEVICE_TYPE</span>(
                                                        <span onmouseout="hideTip(event, 'fs3', 85)" onmouseover="showTip(event, 'fs3', 85)" class="i">DeviceType</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs5', 86)" onmouseover="showTip(event, 'fs5', 86)" class="i">Gpu</span>, 
                                                        <span onmouseout="hideTip(event, 'fs3', 87)" onmouseover="showTip(event, 'fs3', 87)" class="i">VectorAdd</span> 
                                               ) @&gt;)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 88)" onmouseover="showTip(event, 'fs3', 88)" class="i">compilationResultForGpu</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 89)" onmouseover="showTip(event, 'fs3', 89)" class="i">compiler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 90)" onmouseover="showTip(event, 'fs3', 90)" class="i">Compile</span>(&lt;@ <span onmouseout="hideTip(event, 'fs3', 91)" onmouseover="showTip(event, 'fs3', 91)" class="i">DEVICE_TYPE</span>(
                                                        <span onmouseout="hideTip(event, 'fs3', 92)" onmouseover="showTip(event, 'fs3', 92)" class="i">DeviceType</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 93)" onmouseover="showTip(event, 'fs10', 93)" class="i">Cpu</span>, 
                                                        <span onmouseout="hideTip(event, 'fs3', 94)" onmouseover="showTip(event, 'fs3', 94)" class="i">VectorAdd</span>
                                               ) @&gt;)
</pre>
</td>
</tr>
</table>

<h3><a name="Defining-Custom-Metadata" class="anchor" href="#Defining-Custom-Metadata">Defining Custom Metadata</a></h3>

<p>Whenever you develop a custom compiler or runtime step (see <a href="compilerCustomisationTutorial.html">Compiler Customisation Tutorial</a>) that may act differently depending on some user hints, I suggest to leverage on a custom metadata to encode that hint or suggestion that the user can give you.
Defining custom metadata is really easy, there are only two things you need to do:</p>

<ul>
<li><p>Define your new metadata subclassing <code>KernelMetadataAttribute</code> or <code>ParameterMetadataAttribute</code>: 
the first is the base class of all the metadata that can be associated to kernels, while the second is the base class
of all the metadata associated to kernel parameters or kernel return values.</p></li>
<li><p>Define a function that enables to specify the metadata value dynamically, that is whenever you execute a kernel. 
Mark this function with the attribute <code>KernelMetadataFunction(type)</code>, <code>ParameterMetadataFunction(type)</code> or <code>ReturnMetadataFunction(type)</code>,
depending on the target you have planned for your custom metadata.</p></li>
</ul>

<p>Let's show an example. Assume we developed a compiler step processor that "flatten" vector types (such as <code>float4</code>, <code>int3</code>, <code>uint8</code>) 
into the corresponding scalar types.
We want to enable the programmer to decide whether to flatten a kernel parameter or not. 
Since FSCL kernels can return arrays we should also provide a way to tell the compiler step to flatten returned arrays (if they contain values of some vector type).</p>

<h3><a name="Define-dynamic-metadata-attribute" class="anchor" href="#Define-dynamic-metadata-attribute">Define dynamic metadata attribute</a></h3>

<p>The first step is to define a custom attribute to statically mark kernel paramters and return type.
The only important thing to remember is to always give your custom meta a default constructor. 
In fact, whenever we define a custom parameter metadata (but the same holds for kernel metadata), every possible kernel parameter 
will have an instance of that metadata associated. 
If the programmer does not associate any instance of our metadata to a kernel parameter, the parameter will still hold a value for that metadata, which is obtained by invoking its default constructor.
In other words, if a programmer does not specify a particular parameter meta, it is exactly like he was instantiating that meta using the default constructor.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs3', 95)" onmouseover="showTip(event, 'fs3', 95)" class="t">DevectorizeAttribute</span>(<span onmouseout="hideTip(event, 'fs3', 96)" onmouseover="showTip(event, 'fs3', 96)" class="i">enable</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 97)" onmouseover="showTip(event, 'fs3', 97)" class="t">bool</span>) <span class="o">=</span>
    <span class="k">inherit</span> <span onmouseout="hideTip(event, 'fs3', 98)" onmouseover="showTip(event, 'fs3', 98)" class="t">ParameterMetadataAttribute</span>()
    <span class="k">member</span> <span class="k">val</span> <span onmouseout="hideTip(event, 'fs3', 99)" onmouseover="showTip(event, 'fs3', 99)" class="i">Enable</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 100)" onmouseover="showTip(event, 'fs3', 100)" class="i">enable</span> <span class="k">with</span> <span onmouseout="hideTip(event, 'fs3', 101)" onmouseover="showTip(event, 'fs3', 101)" class="i">get</span>
    <span class="k">new</span>() <span class="o">=</span>
        <span onmouseout="hideTip(event, 'fs3', 102)" onmouseover="showTip(event, 'fs3', 102)" class="t">DevectorizeAttribute</span>(<span class="k">false</span>)
</pre>
</td>
</tr>
</table>

<h3><a name="Define-metadata-function" class="anchor" href="#Define-metadata-function">Define metadata function</a></h3>

<p>If we want to enable programmers to dynamically provide a value for your meta when a particular instance of the kernel is executed (i.e. inside quotations), 
we need to define a function that "emulates" the .NET custom attribute in a dynamic context.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 103)" onmouseover="showTip(event, 'fs3', 103)" class="i">ParameterMetadataFunction</span>(<span onmouseout="hideTip(event, 'fs3', 104)" onmouseover="showTip(event, 'fs3', 104)" class="i">typeof</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 105)" onmouseover="showTip(event, 'fs3', 105)" class="i">DevectorizeAttribute</span><span class="o">&gt;</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 106)" onmouseover="showTip(event, 'fs3', 106)" class="f">DEVECTORIZE</span>(<span onmouseout="hideTip(event, 'fs3', 107)" onmouseover="showTip(event, 'fs3', 107)" class="i">enable</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 108)" onmouseover="showTip(event, 'fs3', 108)" class="t">bool</span>, <span onmouseout="hideTip(event, 'fs11', 109)" onmouseover="showTip(event, 'fs11', 109)" class="i">a</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs11', 110)" onmouseover="showTip(event, 'fs11', 110)" class="i">a</span>

[&lt;<span onmouseout="hideTip(event, 'fs3', 111)" onmouseover="showTip(event, 'fs3', 111)" class="i">ReturnMetadataFunction</span>(<span onmouseout="hideTip(event, 'fs3', 112)" onmouseover="showTip(event, 'fs3', 112)" class="i">typeof</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 113)" onmouseover="showTip(event, 'fs3', 113)" class="i">DevectorizeAttribute</span><span class="o">&gt;</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 114)" onmouseover="showTip(event, 'fs3', 114)" class="f">DEVECTORIZE_RETURN</span>(<span onmouseout="hideTip(event, 'fs3', 115)" onmouseover="showTip(event, 'fs3', 115)" class="i">enable</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 116)" onmouseover="showTip(event, 'fs3', 116)" class="t">bool</span>, <span onmouseout="hideTip(event, 'fs11', 117)" onmouseover="showTip(event, 'fs11', 117)" class="i">a</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs11', 118)" onmouseover="showTip(event, 'fs11', 118)" class="i">a</span> 
</pre>
</td>
</tr>
</table>

<p>Since the metadata can be associated to both parameters and return values, two distinct functions are requires. 
This is (unfortunately) required to enable FSCL to distinguish whether a metadata is associated to a parameter or to the return value when the metadata function wraps a subkernel, 
that is a kernel passed as parameter to another kernel.</p>

<h3><a name="Employing-metadata-in-kernel-programming" class="anchor" href="#Employing-metadata-in-kernel-programming">Employing metadata in kernel programming</a></h3>

<p>Once define a custom metadata attribute and a matching metadata function, 
programmers can mark parameters and return types in kernel definitions as well as actual arguments an return values in kernel calls.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="c">// Static metadata are associated to kernel definition</span>
[&lt;<span onmouseout="hideTip(event, 'fs3', 119)" onmouseover="showTip(event, 'fs3', 119)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] 
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 120)" onmouseover="showTip(event, 'fs3', 120)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs12', 121)" onmouseover="showTip(event, 'fs12', 121)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 122)" onmouseover="showTip(event, 'fs3', 122)" class="t">float4</span>[], 
             [&lt;<span onmouseout="hideTip(event, 'fs3', 123)" onmouseover="showTip(event, 'fs3', 123)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] 
             <span onmouseout="hideTip(event, 'fs13', 124)" onmouseover="showTip(event, 'fs13', 124)" class="i">b</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 125)" onmouseover="showTip(event, 'fs3', 125)" class="t">float4</span>[], 
             <span onmouseout="hideTip(event, 'fs14', 126)" onmouseover="showTip(event, 'fs14', 126)" class="i">c</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 127)" onmouseover="showTip(event, 'fs3', 127)" class="t">float4</span>[]) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs15', 128)" onmouseover="showTip(event, 'fs15', 128)" class="i">d</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 129)" onmouseover="showTip(event, 'fs3', 129)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 130)" onmouseover="showTip(event, 'fs16', 130)" class="f">zeroCreate</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 131)" onmouseover="showTip(event, 'fs3', 131)" class="t">float4</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs12', 132)" onmouseover="showTip(event, 'fs12', 132)" class="i">a</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 133)" onmouseover="showTip(event, 'fs17', 133)" class="i">Length</span>
    <span class="c">// ...</span>
    <span onmouseout="hideTip(event, 'fs15', 134)" onmouseover="showTip(event, 'fs15', 134)" class="i">d</span>
    
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs18', 135)" onmouseover="showTip(event, 'fs18', 135)" class="i">a</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 136)" onmouseover="showTip(event, 'fs3', 136)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 137)" onmouseover="showTip(event, 'fs19', 137)" class="f">create</span> <span class="n">1024</span> (<span onmouseout="hideTip(event, 'fs3', 138)" onmouseover="showTip(event, 'fs3', 138)" class="t">float4</span>(<span class="n">0.0f</span>))
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs20', 139)" onmouseover="showTip(event, 'fs20', 139)" class="i">b</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 140)" onmouseover="showTip(event, 'fs3', 140)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 141)" onmouseover="showTip(event, 'fs19', 141)" class="f">create</span> <span class="n">1024</span> (<span onmouseout="hideTip(event, 'fs3', 142)" onmouseover="showTip(event, 'fs3', 142)" class="t">float4</span>(<span class="n">0.0f</span>))
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs21', 143)" onmouseover="showTip(event, 'fs21', 143)" class="i">c</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 144)" onmouseover="showTip(event, 'fs3', 144)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 145)" onmouseover="showTip(event, 'fs16', 145)" class="f">zeroCreate</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 146)" onmouseover="showTip(event, 'fs3', 146)" class="t">float4</span><span class="o">&gt;</span> <span class="n">1024</span>

<span class="c">// Dynamic metadata functions override static metadata in kernel execution</span>
<span class="c">// Override return</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 147)" onmouseover="showTip(event, 'fs3', 147)" class="i">overrideReturn</span> <span class="o">=</span> &lt;@ <span onmouseout="hideTip(event, 'fs3', 148)" onmouseover="showTip(event, 'fs3', 148)" class="f">DEVECTORIZE_RETURN</span>(<span class="k">false</span>, <span onmouseout="hideTip(event, 'fs3', 149)" onmouseover="showTip(event, 'fs3', 149)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs18', 150)" onmouseover="showTip(event, 'fs18', 150)" class="i">a</span>, <span onmouseout="hideTip(event, 'fs20', 151)" onmouseover="showTip(event, 'fs20', 151)" class="i">b</span>, <span onmouseout="hideTip(event, 'fs21', 152)" onmouseover="showTip(event, 'fs21', 152)" class="i">c</span>)) @&gt;

<span class="c">// Override devectorize metadata value for b</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 153)" onmouseover="showTip(event, 'fs3', 153)" class="i">overrideB</span> <span class="o">=</span> &lt;@ <span onmouseout="hideTip(event, 'fs3', 154)" onmouseover="showTip(event, 'fs3', 154)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs18', 155)" onmouseover="showTip(event, 'fs18', 155)" class="i">a</span>, <span onmouseout="hideTip(event, 'fs3', 156)" onmouseover="showTip(event, 'fs3', 156)" class="f">DEVECTORIZE</span>(<span class="k">false</span>, <span onmouseout="hideTip(event, 'fs20', 157)" onmouseover="showTip(event, 'fs20', 157)" class="i">b</span>), <span onmouseout="hideTip(event, 'fs21', 158)" onmouseover="showTip(event, 'fs21', 158)" class="i">c</span>) @&gt;
</pre>
</td>
</tr>
</table>

<p>Remember that if programmers do not specify any devectorize metadata value for a parameter or return value, 
it is exactly like they specified the default value.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="c">// This one...</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 159)" onmouseover="showTip(event, 'fs3', 159)" class="f">MyKernel</span>(<span onmouseout="hideTip(event, 'fs12', 160)" onmouseover="showTip(event, 'fs12', 160)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 161)" onmouseover="showTip(event, 'fs3', 161)" class="t">float4</span>[], 
             [&lt;<span onmouseout="hideTip(event, 'fs3', 162)" onmouseover="showTip(event, 'fs3', 162)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] 
             <span onmouseout="hideTip(event, 'fs13', 163)" onmouseover="showTip(event, 'fs13', 163)" class="i">b</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 164)" onmouseover="showTip(event, 'fs3', 164)" class="t">float4</span>[], 
             <span onmouseout="hideTip(event, 'fs14', 165)" onmouseover="showTip(event, 'fs14', 165)" class="i">c</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 166)" onmouseover="showTip(event, 'fs3', 166)" class="t">float4</span>[]) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs15', 167)" onmouseover="showTip(event, 'fs15', 167)" class="i">d</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 168)" onmouseover="showTip(event, 'fs3', 168)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 169)" onmouseover="showTip(event, 'fs16', 169)" class="f">zeroCreate</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 170)" onmouseover="showTip(event, 'fs3', 170)" class="t">float4</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs12', 171)" onmouseover="showTip(event, 'fs12', 171)" class="i">a</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 172)" onmouseover="showTip(event, 'fs17', 172)" class="i">Length</span>
    <span class="c">// ...</span>
    <span onmouseout="hideTip(event, 'fs15', 173)" onmouseover="showTip(event, 'fs15', 173)" class="i">d</span>

<span class="c">// ...is equivalent to (since default constructor assigns &quot;false&quot; to DevectorizeAttribute &quot;Enable&quot; property) </span>
[&lt;<span onmouseout="hideTip(event, 'fs3', 174)" onmouseover="showTip(event, 'fs3', 174)" class="t">Devectorize</span>(<span class="k">false</span>)&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 175)" onmouseover="showTip(event, 'fs3', 175)" class="f">MyKernel</span>([&lt;<span onmouseout="hideTip(event, 'fs3', 176)" onmouseover="showTip(event, 'fs3', 176)" class="t">Devectorize</span>(<span class="k">false</span>)&gt;] <span onmouseout="hideTip(event, 'fs12', 177)" onmouseover="showTip(event, 'fs12', 177)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 178)" onmouseover="showTip(event, 'fs3', 178)" class="t">float4</span>[],
             [&lt;<span onmouseout="hideTip(event, 'fs3', 179)" onmouseover="showTip(event, 'fs3', 179)" class="t">Devectorize</span>(<span class="k">true</span>)&gt;] <span onmouseout="hideTip(event, 'fs13', 180)" onmouseover="showTip(event, 'fs13', 180)" class="i">b</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 181)" onmouseover="showTip(event, 'fs3', 181)" class="t">float4</span>[], 
             [&lt;<span onmouseout="hideTip(event, 'fs3', 182)" onmouseover="showTip(event, 'fs3', 182)" class="t">Devectorize</span>(<span class="k">false</span>)&gt;] <span onmouseout="hideTip(event, 'fs14', 183)" onmouseover="showTip(event, 'fs14', 183)" class="i">c</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 184)" onmouseover="showTip(event, 'fs3', 184)" class="t">float4</span>[]) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs15', 185)" onmouseover="showTip(event, 'fs15', 185)" class="i">d</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 186)" onmouseover="showTip(event, 'fs3', 186)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 187)" onmouseover="showTip(event, 'fs16', 187)" class="f">zeroCreate</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 188)" onmouseover="showTip(event, 'fs3', 188)" class="t">float4</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs12', 189)" onmouseover="showTip(event, 'fs12', 189)" class="i">a</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 190)" onmouseover="showTip(event, 'fs17', 190)" class="i">Length</span>
    <span class="c">// ...</span>
    <span onmouseout="hideTip(event, 'fs15', 191)" onmouseover="showTip(event, 'fs15', 191)" class="i">d</span>
</pre>
</td>
</tr>
</table>

<div class="tip" id="fs1">namespace FSCL</div>
<div class="tip" id="fs2">namespace FSCL.Compiler</div>
<div class="tip" id="fs3"></div>
<div class="tip" id="fs4">module Language<br /><br />from FSCL</div>
<div class="tip" id="fs5">DeviceType.Gpu: DeviceType = 4</div>
<div class="tip" id="fs6">val a : float32 []</div>
<div class="tip" id="fs7">val b : float32 []</div>
<div class="tip" id="fs8">val c : float32 []</div>
<div class="tip" id="fs9">abstract member WorkItemInfo.GlobalID : int -&gt; int</div>
<div class="tip" id="fs10">DeviceType.Cpu: DeviceType = 2</div>
<div class="tip" id="fs11">val a : &#39;a</div>
<div class="tip" id="fs12">val a : float4 []</div>
<div class="tip" id="fs13">val b : float4 []</div>
<div class="tip" id="fs14">val c : float4 []</div>
<div class="tip" id="fs15">val d : float4 []</div>
<div class="tip" id="fs16">val zeroCreate : count:int -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.zeroCreate</div>
<div class="tip" id="fs17">property System.Array.Length: int</div>
<div class="tip" id="fs18">val a : float4 []<br /><br />Full name: DynamicMetadataTutorial.a</div>
<div class="tip" id="fs19">val create : count:int -&gt; value:&#39;T -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.create</div>
<div class="tip" id="fs20">val b : float4 []<br /><br />Full name: DynamicMetadataTutorial.b</div>
<div class="tip" id="fs21">val c : float4 []<br /><br />Full name: DynamicMetadataTutorial.c</div>

        </section>
        <footer>
            <p>This project is maintained by <a href="http://github.com/FSCL">Gabriele Cocco</a></p>
        </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
</body>
</html>