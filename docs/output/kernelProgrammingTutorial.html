<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>FSCL Kernel Programming
</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="F# to OpenCL compiler" />
    <meta name="author" content="Gabriele Cocco" />
    <script type="text/javascript" src="javascripts/jquery-1.11.1.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("table.pre").wrap("<div class='code-container'></div>");
            $("table.pre").css("width", ($("section").width() - 30) + "px");
            $("pre.fssnip").css("width", ($("section").width() - 30) + "px");
            $(window).resize(function () {
                $("table.pre").css("width", ($("section").width() - 30) + "px");
                $("pre.fssnip").css("width", ($("section").width() - 30) + "px");
            });
        });
    </script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <div class="wrapper">
        <header>
            <div class="header-container">
                <h1><a href="/FSCL.Compiler">FSCL.Compiler</a></h1>
                <p>F# to OpenCL compiler</p>
            </div>
            <table class="git-links">
                <tr>
                    <td><a href="https://github.com/FSCL/FSCL.Runtime/zipball/master">Download <strong>ZIP File</strong></a></td>
                    <td><a href="https://github.com/FSCL/FSCL.Runtime/tarball/master">Download <strong>TAR Ball</strong></a></td>
                    <td><a href="http://github.com/FSCL/FSCL.Runtime/master">Fork On <strong>GitHub</strong></a></td>
                </tr>
            </table>
        </header>
        <section>
            
<h1><a name="FSCL-Kernel-Programming" class="anchor" href="#FSCL-Kernel-Programming">FSCL Kernel Programming</a></h1>

<p>With the compiler and the object-model provided by the FSCL.Compiler project you can write OpenCL kernels
as F# functions, static/instance methods and lambdas. This page gives an overview on kernel programming in FSCL.</p>

<h3><a name="Basic-example-Vector-Addition" class="anchor" href="#Basic-example-Vector-Addition">Basic example: Vector Addition</a></h3>

<p>The most simple example of kernel programming is very likely parallel vector addition, where each thread (known as work-item in OpenCL)
sums the matching elements of the two input vectors whose index is determined by the thread id.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">FSCL</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 2)" onmouseover="showTip(event, 'fs1', 2)" class="i">FSCL</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">Compiler</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="i">FSCL</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="i">Language</span>

[&lt;<span onmouseout="hideTip(event, 'fs3', 6)" onmouseover="showTip(event, 'fs3', 6)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 7)" onmouseover="showTip(event, 'fs3', 7)" class="f">VectorAdd</span>(<span onmouseout="hideTip(event, 'fs5', 8)" onmouseover="showTip(event, 'fs5', 8)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 9)" onmouseover="showTip(event, 'fs3', 9)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 10)" onmouseover="showTip(event, 'fs6', 10)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 11)" onmouseover="showTip(event, 'fs3', 11)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 12)" onmouseover="showTip(event, 'fs7', 12)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 13)" onmouseover="showTip(event, 'fs3', 13)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 14)" onmouseover="showTip(event, 'fs3', 14)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 15)" onmouseover="showTip(event, 'fs3', 15)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 16)" onmouseover="showTip(event, 'fs3', 16)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 17)" onmouseover="showTip(event, 'fs3', 17)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 18)" onmouseover="showTip(event, 'fs8', 18)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs7', 19)" onmouseover="showTip(event, 'fs7', 19)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 20)" onmouseover="showTip(event, 'fs3', 20)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs5', 21)" onmouseover="showTip(event, 'fs5', 21)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 22)" onmouseover="showTip(event, 'fs3', 22)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs6', 23)" onmouseover="showTip(event, 'fs6', 23)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 24)" onmouseover="showTip(event, 'fs3', 24)" class="i">myId</span>]
</pre>
</td>
</tr>
</table>

<p>Every FSCL kernel is characterized by an additional parameter of type <code>WorkItemInfo</code> (not necessarily the last one) that is used from within the kernel body
to retrieve all the information related to the work-items space (global/local id of the thread, global/local thread count, work-items space rank, etc.).
In addition, every kernel must be marked with <code>[&lt;ReflectedDefinition&gt;]</code> attribute to enable the compiler to inspect the AST of its body.</p>

<h3><a name="A-more-complex-example-Sobel-Filter" class="anchor" href="#A-more-complex-example-Sobel-Filter">A more complex example: Sobel Filter</a></h3>

<p>The FSCL compiler library exposes an object-model that allows to write every possible OpenCL kernel in F#. In particular,
all the OpenCL built-in math/vector data/geometric functions are available to be used inside kernels, as like as vector data-types (e.g. float4, int3)
and parameter qualifiers (e.g. __local_, __constant). The <em>Image</em> subset of OpenCL has not been ported to FSCL yet, but it will be very soon.</p>

<p>The following example shows some of these features applied to the Sobel filter algorithm optimised for GPU execution.
In particular, we use vector data-types (<code>float4</code>, <code>uchar4</code>), we perform vector-types conversions (<code>ToFloat4()</code>, <code>ToUChar4()</code>) 
and we use built-in OpenCL math functions, such as <code>float4.hypot()</code>.
An important aspect to note is that the function input are 2D arrays. 
In fact, while in OpenCL C, kernel inputs are restricted to flat 1D arrays, FSCL allows to work with data of type <code>Array2D</code> and <code>Array3D</code>. The compiler
will automatically flat every istance of those types and appropriately manipulate the indexes used to access it.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 25)" onmouseover="showTip(event, 'fs3', 25)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 26)" onmouseover="showTip(event, 'fs3', 26)" class="f">SobelFilter2D</span>(<span onmouseout="hideTip(event, 'fs3', 27)" onmouseover="showTip(event, 'fs3', 27)" class="i">inputImage</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 28)" onmouseover="showTip(event, 'fs3', 28)" class="t">uchar4</span>[,], <span onmouseout="hideTip(event, 'fs3', 29)" onmouseover="showTip(event, 'fs3', 29)" class="i">outputImage</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 30)" onmouseover="showTip(event, 'fs3', 30)" class="t">uchar4</span>[,], <span onmouseout="hideTip(event, 'fs3', 31)" onmouseover="showTip(event, 'fs3', 31)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 32)" onmouseover="showTip(event, 'fs3', 32)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs9', 33)" onmouseover="showTip(event, 'fs9', 33)" class="i">x</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 34)" onmouseover="showTip(event, 'fs3', 34)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 35)" onmouseover="showTip(event, 'fs8', 35)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs10', 36)" onmouseover="showTip(event, 'fs10', 36)" class="i">y</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 37)" onmouseover="showTip(event, 'fs3', 37)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 38)" onmouseover="showTip(event, 'fs8', 38)" class="f">GlobalID</span>(<span class="n">1</span>)

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 39)" onmouseover="showTip(event, 'fs3', 39)" class="i">width</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 40)" onmouseover="showTip(event, 'fs3', 40)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 41)" onmouseover="showTip(event, 'fs11', 41)" class="f">GlobalSize</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 42)" onmouseover="showTip(event, 'fs3', 42)" class="i">height</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 43)" onmouseover="showTip(event, 'fs3', 43)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 44)" onmouseover="showTip(event, 'fs11', 44)" class="f">GlobalSize</span>(<span class="n">1</span>)

    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 45)" onmouseover="showTip(event, 'fs3', 45)" class="v">Gx</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 46)" onmouseover="showTip(event, 'fs3', 46)" class="t">float4</span>(<span class="n">0.0f</span>)
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 47)" onmouseover="showTip(event, 'fs3', 47)" class="v">Gy</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 48)" onmouseover="showTip(event, 'fs3', 48)" class="v">Gx</span>

    <span class="c">// Read each texel component and calculate the filtered value using neighbouring texel components </span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 49)" onmouseover="showTip(event, 'fs3', 49)" class="i">i00</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 50)" onmouseover="showTip(event, 'fs3', 50)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 51)" onmouseover="showTip(event, 'fs10', 51)" class="i">y</span>, <span onmouseout="hideTip(event, 'fs9', 52)" onmouseover="showTip(event, 'fs9', 52)" class="i">x</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 53)" onmouseover="showTip(event, 'fs3', 53)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 54)" onmouseover="showTip(event, 'fs3', 54)" class="i">i10</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 55)" onmouseover="showTip(event, 'fs3', 55)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 56)" onmouseover="showTip(event, 'fs10', 56)" class="i">y</span>, <span onmouseout="hideTip(event, 'fs9', 57)" onmouseover="showTip(event, 'fs9', 57)" class="i">x</span> <span class="o">+</span> <span class="n">1</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 58)" onmouseover="showTip(event, 'fs3', 58)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 59)" onmouseover="showTip(event, 'fs3', 59)" class="i">i20</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 60)" onmouseover="showTip(event, 'fs3', 60)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 61)" onmouseover="showTip(event, 'fs10', 61)" class="i">y</span>, <span onmouseout="hideTip(event, 'fs9', 62)" onmouseover="showTip(event, 'fs9', 62)" class="i">x</span> <span class="o">+</span> <span class="n">2</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 63)" onmouseover="showTip(event, 'fs3', 63)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 64)" onmouseover="showTip(event, 'fs3', 64)" class="i">i01</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 65)" onmouseover="showTip(event, 'fs3', 65)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 66)" onmouseover="showTip(event, 'fs10', 66)" class="i">y</span> <span class="o">+</span> <span class="n">1</span>, <span onmouseout="hideTip(event, 'fs9', 67)" onmouseover="showTip(event, 'fs9', 67)" class="i">x</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 68)" onmouseover="showTip(event, 'fs3', 68)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 69)" onmouseover="showTip(event, 'fs3', 69)" class="i">i11</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 70)" onmouseover="showTip(event, 'fs3', 70)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 71)" onmouseover="showTip(event, 'fs10', 71)" class="i">y</span> <span class="o">+</span> <span class="n">1</span>, <span onmouseout="hideTip(event, 'fs9', 72)" onmouseover="showTip(event, 'fs9', 72)" class="i">x</span> <span class="o">+</span> <span class="n">1</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 73)" onmouseover="showTip(event, 'fs3', 73)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 74)" onmouseover="showTip(event, 'fs3', 74)" class="i">i21</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 75)" onmouseover="showTip(event, 'fs3', 75)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 76)" onmouseover="showTip(event, 'fs10', 76)" class="i">y</span> <span class="o">+</span> <span class="n">1</span>, <span onmouseout="hideTip(event, 'fs9', 77)" onmouseover="showTip(event, 'fs9', 77)" class="i">x</span> <span class="o">+</span> <span class="n">2</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 78)" onmouseover="showTip(event, 'fs3', 78)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 79)" onmouseover="showTip(event, 'fs3', 79)" class="i">i02</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 80)" onmouseover="showTip(event, 'fs3', 80)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 81)" onmouseover="showTip(event, 'fs10', 81)" class="i">y</span> <span class="o">+</span> <span class="n">2</span>, <span onmouseout="hideTip(event, 'fs9', 82)" onmouseover="showTip(event, 'fs9', 82)" class="i">x</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 83)" onmouseover="showTip(event, 'fs3', 83)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 84)" onmouseover="showTip(event, 'fs3', 84)" class="i">i12</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 85)" onmouseover="showTip(event, 'fs3', 85)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 86)" onmouseover="showTip(event, 'fs10', 86)" class="i">y</span> <span class="o">+</span> <span class="n">2</span>, <span onmouseout="hideTip(event, 'fs9', 87)" onmouseover="showTip(event, 'fs9', 87)" class="i">x</span> <span class="o">+</span> <span class="n">1</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 88)" onmouseover="showTip(event, 'fs3', 88)" class="f">ToFloat4</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 89)" onmouseover="showTip(event, 'fs3', 89)" class="i">i22</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs3', 90)" onmouseover="showTip(event, 'fs3', 90)" class="i">inputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 91)" onmouseover="showTip(event, 'fs10', 91)" class="i">y</span> <span class="o">+</span> <span class="n">2</span>, <span onmouseout="hideTip(event, 'fs9', 92)" onmouseover="showTip(event, 'fs9', 92)" class="i">x</span> <span class="o">+</span> <span class="n">2</span>])<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 93)" onmouseover="showTip(event, 'fs3', 93)" class="f">ToFloat4</span>()

    <span onmouseout="hideTip(event, 'fs3', 94)" onmouseover="showTip(event, 'fs3', 94)" class="v">Gx</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 95)" onmouseover="showTip(event, 'fs3', 95)" class="i">i00</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 96)" onmouseover="showTip(event, 'fs3', 96)" class="t">float4</span>(<span class="n">2.0f</span>) <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 97)" onmouseover="showTip(event, 'fs3', 97)" class="i">i10</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 98)" onmouseover="showTip(event, 'fs3', 98)" class="i">i20</span> <span class="o">-</span> <span onmouseout="hideTip(event, 'fs3', 99)" onmouseover="showTip(event, 'fs3', 99)" class="i">i02</span>  <span class="o">-</span> <span onmouseout="hideTip(event, 'fs3', 100)" onmouseover="showTip(event, 'fs3', 100)" class="t">float4</span>(<span class="n">2.0f</span>) <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 101)" onmouseover="showTip(event, 'fs3', 101)" class="i">i12</span> <span class="o">-</span> <span onmouseout="hideTip(event, 'fs3', 102)" onmouseover="showTip(event, 'fs3', 102)" class="i">i22</span>
    <span onmouseout="hideTip(event, 'fs3', 103)" onmouseover="showTip(event, 'fs3', 103)" class="v">Gy</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 104)" onmouseover="showTip(event, 'fs3', 104)" class="i">i00</span> <span class="o">-</span> <span onmouseout="hideTip(event, 'fs3', 105)" onmouseover="showTip(event, 'fs3', 105)" class="i">i20</span>  <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 106)" onmouseover="showTip(event, 'fs3', 106)" class="t">float4</span>(<span class="n">2.0f</span>) <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 107)" onmouseover="showTip(event, 'fs3', 107)" class="i">i01</span> <span class="o">-</span> <span onmouseout="hideTip(event, 'fs3', 108)" onmouseover="showTip(event, 'fs3', 108)" class="t">float4</span>(<span class="n">2.0f</span>) <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 109)" onmouseover="showTip(event, 'fs3', 109)" class="i">i21</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 110)" onmouseover="showTip(event, 'fs3', 110)" class="i">i02</span> <span class="o">-</span> <span onmouseout="hideTip(event, 'fs3', 111)" onmouseover="showTip(event, 'fs3', 111)" class="i">i22</span>

    <span onmouseout="hideTip(event, 'fs3', 112)" onmouseover="showTip(event, 'fs3', 112)" class="i">outputImage</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs10', 113)" onmouseover="showTip(event, 'fs10', 113)" class="i">y</span>, <span onmouseout="hideTip(event, 'fs9', 114)" onmouseover="showTip(event, 'fs9', 114)" class="i">x</span>] <span class="o">&lt;-</span> (<span onmouseout="hideTip(event, 'fs3', 115)" onmouseover="showTip(event, 'fs3', 115)" class="t">float4</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs12', 116)" onmouseover="showTip(event, 'fs12', 116)" class="f">hypot</span>(<span onmouseout="hideTip(event, 'fs3', 117)" onmouseover="showTip(event, 'fs3', 117)" class="v">Gx</span>, <span onmouseout="hideTip(event, 'fs3', 118)" onmouseover="showTip(event, 'fs3', 118)" class="v">Gy</span>)<span class="o">/</span><span onmouseout="hideTip(event, 'fs3', 119)" onmouseover="showTip(event, 'fs3', 119)" class="t">float4</span>(<span class="n">2.0f</span>))<span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 120)" onmouseover="showTip(event, 'fs3', 120)" class="f">ToUChar4</span>()
</pre>
</td>
</tr>
</table>

<h3><a name="Another-complex-example-Matrix-Multiplication" class="anchor" href="#Another-complex-example-Matrix-Multiplication">Another complex example: Matrix Multiplication</a></h3>

<p>Matrix multiplication optimised for GPU execution is another example that shows how OpenCL programming
constructs and built-in functions are mapped into F#.
Here, the kernel uses a global property <code>BLOCK_SIZE</code> marked with <code>[&lt;ReflectedDefinition&gt;]</code>. Whenever a kernel
references a reflected property, the compiler produces an appropriate <code>#define</code> in the OpenCL source (in the particular case <code>#define BLOCK_SIZE 16</code>).</p>

<p>The example also shows how to declare <em>local</em> variables (i.e. data shares among the threads in a work group) inside kernels, that is
by wrapping <code>Array.zeroCreate</code> calls in the function <code>local()</code>.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 121)" onmouseover="showTip(event, 'fs3', 121)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 122)" onmouseover="showTip(event, 'fs3', 122)" class="i">BLOCK_SIZE</span> <span class="o">=</span> <span class="n">16</span>
[&lt;<span onmouseout="hideTip(event, 'fs3', 123)" onmouseover="showTip(event, 'fs3', 123)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 124)" onmouseover="showTip(event, 'fs3', 124)" class="f">MatrixMult</span>(<span onmouseout="hideTip(event, 'fs3', 125)" onmouseover="showTip(event, 'fs3', 125)" class="i">matA</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 126)" onmouseover="showTip(event, 'fs3', 126)" class="t">float32</span>[,], <span onmouseout="hideTip(event, 'fs3', 127)" onmouseover="showTip(event, 'fs3', 127)" class="i">matB</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 128)" onmouseover="showTip(event, 'fs3', 128)" class="t">float32</span>[,], <span onmouseout="hideTip(event, 'fs3', 129)" onmouseover="showTip(event, 'fs3', 129)" class="i">matC</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 130)" onmouseover="showTip(event, 'fs3', 130)" class="t">float32</span>[,], <span onmouseout="hideTip(event, 'fs3', 131)" onmouseover="showTip(event, 'fs3', 131)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 132)" onmouseover="showTip(event, 'fs3', 132)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 133)" onmouseover="showTip(event, 'fs3', 133)" class="i">bx</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 134)" onmouseover="showTip(event, 'fs3', 134)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 135)" onmouseover="showTip(event, 'fs13', 135)" class="f">GroupID</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 136)" onmouseover="showTip(event, 'fs3', 136)" class="i">by</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 137)" onmouseover="showTip(event, 'fs3', 137)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 138)" onmouseover="showTip(event, 'fs13', 138)" class="f">GroupID</span>(<span class="n">1</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 139)" onmouseover="showTip(event, 'fs3', 139)" class="i">tx</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 140)" onmouseover="showTip(event, 'fs3', 140)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 141)" onmouseover="showTip(event, 'fs14', 141)" class="f">LocalID</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 142)" onmouseover="showTip(event, 'fs3', 142)" class="i">ty</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 143)" onmouseover="showTip(event, 'fs3', 143)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 144)" onmouseover="showTip(event, 'fs14', 144)" class="f">LocalID</span>(<span class="n">1</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 145)" onmouseover="showTip(event, 'fs3', 145)" class="i">wa</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 146)" onmouseover="showTip(event, 'fs3', 146)" class="i">matA</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 147)" onmouseover="showTip(event, 'fs15', 147)" class="f">GetLength</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 148)" onmouseover="showTip(event, 'fs3', 148)" class="i">wb</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 149)" onmouseover="showTip(event, 'fs3', 149)" class="i">matB</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 150)" onmouseover="showTip(event, 'fs15', 150)" class="f">GetLength</span>(<span class="n">0</span>)

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 151)" onmouseover="showTip(event, 'fs3', 151)" class="i">bCol</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 152)" onmouseover="showTip(event, 'fs3', 152)" class="i">bx</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 153)" onmouseover="showTip(event, 'fs3', 153)" class="i">BLOCK_SIZE</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 154)" onmouseover="showTip(event, 'fs3', 154)" class="i">bBeginRow</span> <span class="o">=</span> <span class="n">0</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 155)" onmouseover="showTip(event, 'fs3', 155)" class="i">bStep</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 156)" onmouseover="showTip(event, 'fs3', 156)" class="i">BLOCK_SIZE</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 157)" onmouseover="showTip(event, 'fs3', 157)" class="v">bRow</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 158)" onmouseover="showTip(event, 'fs3', 158)" class="i">bBeginRow</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 159)" onmouseover="showTip(event, 'fs3', 159)" class="v">Csub</span> <span class="o">=</span> <span class="n">0.0f</span>
 
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 160)" onmouseover="showTip(event, 'fs3', 160)" class="i">As</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 161)" onmouseover="showTip(event, 'fs3', 161)" class="f">local</span>(<span onmouseout="hideTip(event, 'fs3', 162)" onmouseover="showTip(event, 'fs3', 162)" class="t">Array2D</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 163)" onmouseover="showTip(event, 'fs16', 163)" class="f">zeroCreate</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 164)" onmouseover="showTip(event, 'fs3', 164)" class="t">float32</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs3', 165)" onmouseover="showTip(event, 'fs3', 165)" class="i">BLOCK_SIZE</span> <span onmouseout="hideTip(event, 'fs3', 166)" onmouseover="showTip(event, 'fs3', 166)" class="i">BLOCK_SIZE</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 167)" onmouseover="showTip(event, 'fs3', 167)" class="i">Bs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 168)" onmouseover="showTip(event, 'fs3', 168)" class="f">local</span>(<span onmouseout="hideTip(event, 'fs3', 169)" onmouseover="showTip(event, 'fs3', 169)" class="t">Array2D</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 170)" onmouseover="showTip(event, 'fs16', 170)" class="f">zeroCreate</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 171)" onmouseover="showTip(event, 'fs3', 171)" class="t">float32</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs3', 172)" onmouseover="showTip(event, 'fs3', 172)" class="i">BLOCK_SIZE</span> <span onmouseout="hideTip(event, 'fs3', 173)" onmouseover="showTip(event, 'fs3', 173)" class="i">BLOCK_SIZE</span>)

    <span class="k">for</span> <span onmouseout="hideTip(event, 'fs3', 174)" onmouseover="showTip(event, 'fs3', 174)" class="i">aCol</span> <span class="k">in</span> <span class="n">0</span> <span class="o">..</span> <span onmouseout="hideTip(event, 'fs3', 175)" onmouseover="showTip(event, 'fs3', 175)" class="i">BLOCK_SIZE</span> <span class="o">..</span> (<span onmouseout="hideTip(event, 'fs3', 176)" onmouseover="showTip(event, 'fs3', 176)" class="i">wa</span> <span class="o">-</span> <span class="n">1</span>) <span class="k">do</span>
        <span onmouseout="hideTip(event, 'fs3', 177)" onmouseover="showTip(event, 'fs3', 177)" class="i">As</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 178)" onmouseover="showTip(event, 'fs3', 178)" class="i">ty</span>, <span onmouseout="hideTip(event, 'fs3', 179)" onmouseover="showTip(event, 'fs3', 179)" class="i">tx</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 180)" onmouseover="showTip(event, 'fs3', 180)" class="i">matA</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 181)" onmouseover="showTip(event, 'fs3', 181)" class="i">by</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 182)" onmouseover="showTip(event, 'fs3', 182)" class="i">BLOCK_SIZE</span>, <span onmouseout="hideTip(event, 'fs3', 183)" onmouseover="showTip(event, 'fs3', 183)" class="i">aCol</span>]
        <span onmouseout="hideTip(event, 'fs3', 184)" onmouseover="showTip(event, 'fs3', 184)" class="i">Bs</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 185)" onmouseover="showTip(event, 'fs3', 185)" class="i">ty</span>, <span onmouseout="hideTip(event, 'fs3', 186)" onmouseover="showTip(event, 'fs3', 186)" class="i">tx</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 187)" onmouseover="showTip(event, 'fs3', 187)" class="i">matB</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 188)" onmouseover="showTip(event, 'fs3', 188)" class="v">bRow</span>, <span onmouseout="hideTip(event, 'fs3', 189)" onmouseover="showTip(event, 'fs3', 189)" class="i">bCol</span>]
        <span onmouseout="hideTip(event, 'fs3', 190)" onmouseover="showTip(event, 'fs3', 190)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 191)" onmouseover="showTip(event, 'fs3', 191)" class="i">Barrier</span>(<span onmouseout="hideTip(event, 'fs3', 192)" onmouseover="showTip(event, 'fs3', 192)" class="i">CLK_LOCAL_MEM_FENCE</span>)
 
        <span class="k">for</span> <span onmouseout="hideTip(event, 'fs17', 193)" onmouseover="showTip(event, 'fs17', 193)" class="i">k</span> <span class="o">=</span> <span class="n">0</span> <span class="k">to</span> <span onmouseout="hideTip(event, 'fs3', 194)" onmouseover="showTip(event, 'fs3', 194)" class="i">BLOCK_SIZE</span> <span class="o">-</span> <span class="n">1</span> <span class="k">do</span>
            <span onmouseout="hideTip(event, 'fs3', 195)" onmouseover="showTip(event, 'fs3', 195)" class="v">Csub</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 196)" onmouseover="showTip(event, 'fs3', 196)" class="v">Csub</span> <span class="o">+</span> (<span onmouseout="hideTip(event, 'fs3', 197)" onmouseover="showTip(event, 'fs3', 197)" class="i">As</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 198)" onmouseover="showTip(event, 'fs3', 198)" class="i">ty</span>,<span onmouseout="hideTip(event, 'fs17', 199)" onmouseover="showTip(event, 'fs17', 199)" class="i">k</span>] <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 200)" onmouseover="showTip(event, 'fs3', 200)" class="i">Bs</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs17', 201)" onmouseover="showTip(event, 'fs17', 201)" class="i">k</span>,<span onmouseout="hideTip(event, 'fs3', 202)" onmouseover="showTip(event, 'fs3', 202)" class="i">tx</span>])
        <span onmouseout="hideTip(event, 'fs3', 203)" onmouseover="showTip(event, 'fs3', 203)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 204)" onmouseover="showTip(event, 'fs3', 204)" class="i">Barrier</span>(<span onmouseout="hideTip(event, 'fs3', 205)" onmouseover="showTip(event, 'fs3', 205)" class="i">CLK_LOCAL_MEM_FENCE</span>)

        <span onmouseout="hideTip(event, 'fs3', 206)" onmouseover="showTip(event, 'fs3', 206)" class="v">bRow</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 207)" onmouseover="showTip(event, 'fs3', 207)" class="v">bRow</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 208)" onmouseover="showTip(event, 'fs3', 208)" class="i">bStep</span>
    <span onmouseout="hideTip(event, 'fs3', 209)" onmouseover="showTip(event, 'fs3', 209)" class="i">matC</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 210)" onmouseover="showTip(event, 'fs3', 210)" class="i">by</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 211)" onmouseover="showTip(event, 'fs3', 211)" class="i">BLOCK_SIZE</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 212)" onmouseover="showTip(event, 'fs3', 212)" class="i">ty</span>, <span onmouseout="hideTip(event, 'fs3', 213)" onmouseover="showTip(event, 'fs3', 213)" class="i">bx</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 214)" onmouseover="showTip(event, 'fs3', 214)" class="i">BLOCK_SIZE</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 215)" onmouseover="showTip(event, 'fs3', 215)" class="i">tx</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 216)" onmouseover="showTip(event, 'fs3', 216)" class="v">Csub</span>
</pre>
</td>
</tr>
</table>

<p>In OpenCL there are two ways to share data among the threads in a group. The first is by declaring
local variables inside the kernel body as shown in the previous example, the second is by using parameters 
qualified with <em><em></em>local</em>. This last way allows to establish the size of the local data dynamically.</p>

<p>Parameter qualifiers are mapped to FSCL as .NET custom attributes. Given this, we may rewrite the example above,
lifting the local declarations from the kernel body and adding two local parameters as follows:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 217)" onmouseover="showTip(event, 'fs3', 217)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 218)" onmouseover="showTip(event, 'fs3', 218)" class="f">MatrixMultWithLocalParam</span>(<span onmouseout="hideTip(event, 'fs3', 219)" onmouseover="showTip(event, 'fs3', 219)" class="i">matA</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 220)" onmouseover="showTip(event, 'fs3', 220)" class="t">float32</span>[,], 
                             <span onmouseout="hideTip(event, 'fs3', 221)" onmouseover="showTip(event, 'fs3', 221)" class="i">matB</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 222)" onmouseover="showTip(event, 'fs3', 222)" class="t">float32</span>[,], 
                             <span onmouseout="hideTip(event, 'fs3', 223)" onmouseover="showTip(event, 'fs3', 223)" class="i">matC</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 224)" onmouseover="showTip(event, 'fs3', 224)" class="t">float32</span>[,], 
                             [&lt;<span onmouseout="hideTip(event, 'fs3', 225)" onmouseover="showTip(event, 'fs3', 225)" class="t">AddressSpace</span>(<span onmouseout="hideTip(event, 'fs3', 226)" onmouseover="showTip(event, 'fs3', 226)" class="t">AddressSpace</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 227)" onmouseover="showTip(event, 'fs18', 227)" class="i">Local</span>)&gt;]
                             <span onmouseout="hideTip(event, 'fs3', 228)" onmouseover="showTip(event, 'fs3', 228)" class="i">As</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 229)" onmouseover="showTip(event, 'fs3', 229)" class="t">float32</span>[,],
                             [&lt;<span onmouseout="hideTip(event, 'fs3', 230)" onmouseover="showTip(event, 'fs3', 230)" class="t">AddressSpace</span>(<span onmouseout="hideTip(event, 'fs3', 231)" onmouseover="showTip(event, 'fs3', 231)" class="t">AddressSpace</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 232)" onmouseover="showTip(event, 'fs18', 232)" class="i">Local</span>)&gt;]
                             <span onmouseout="hideTip(event, 'fs3', 233)" onmouseover="showTip(event, 'fs3', 233)" class="i">Bs</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 234)" onmouseover="showTip(event, 'fs3', 234)" class="t">float32</span>[,],
                             <span onmouseout="hideTip(event, 'fs3', 235)" onmouseover="showTip(event, 'fs3', 235)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 236)" onmouseover="showTip(event, 'fs3', 236)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 237)" onmouseover="showTip(event, 'fs3', 237)" class="i">bx</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 238)" onmouseover="showTip(event, 'fs3', 238)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 239)" onmouseover="showTip(event, 'fs13', 239)" class="f">GroupID</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 240)" onmouseover="showTip(event, 'fs3', 240)" class="i">by</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 241)" onmouseover="showTip(event, 'fs3', 241)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 242)" onmouseover="showTip(event, 'fs13', 242)" class="f">GroupID</span>(<span class="n">1</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 243)" onmouseover="showTip(event, 'fs3', 243)" class="i">tx</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 244)" onmouseover="showTip(event, 'fs3', 244)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 245)" onmouseover="showTip(event, 'fs14', 245)" class="f">LocalID</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 246)" onmouseover="showTip(event, 'fs3', 246)" class="i">ty</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 247)" onmouseover="showTip(event, 'fs3', 247)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 248)" onmouseover="showTip(event, 'fs14', 248)" class="f">LocalID</span>(<span class="n">1</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 249)" onmouseover="showTip(event, 'fs3', 249)" class="i">wa</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 250)" onmouseover="showTip(event, 'fs3', 250)" class="i">matA</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 251)" onmouseover="showTip(event, 'fs15', 251)" class="f">GetLength</span>(<span class="n">0</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 252)" onmouseover="showTip(event, 'fs3', 252)" class="i">wb</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 253)" onmouseover="showTip(event, 'fs3', 253)" class="i">matB</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 254)" onmouseover="showTip(event, 'fs15', 254)" class="f">GetLength</span>(<span class="n">0</span>)

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 255)" onmouseover="showTip(event, 'fs3', 255)" class="i">bCol</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 256)" onmouseover="showTip(event, 'fs3', 256)" class="i">bx</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 257)" onmouseover="showTip(event, 'fs3', 257)" class="i">BLOCK_SIZE</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 258)" onmouseover="showTip(event, 'fs3', 258)" class="i">bBeginRow</span> <span class="o">=</span> <span class="n">0</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 259)" onmouseover="showTip(event, 'fs3', 259)" class="i">bStep</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 260)" onmouseover="showTip(event, 'fs3', 260)" class="i">BLOCK_SIZE</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 261)" onmouseover="showTip(event, 'fs3', 261)" class="v">bRow</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 262)" onmouseover="showTip(event, 'fs3', 262)" class="i">bBeginRow</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 263)" onmouseover="showTip(event, 'fs3', 263)" class="v">Csub</span> <span class="o">=</span> <span class="n">0.0f</span>

    <span class="k">for</span> <span onmouseout="hideTip(event, 'fs3', 264)" onmouseover="showTip(event, 'fs3', 264)" class="i">aCol</span> <span class="k">in</span> <span class="n">0</span> <span class="o">..</span> <span onmouseout="hideTip(event, 'fs3', 265)" onmouseover="showTip(event, 'fs3', 265)" class="i">BLOCK_SIZE</span> <span class="o">..</span> (<span onmouseout="hideTip(event, 'fs3', 266)" onmouseover="showTip(event, 'fs3', 266)" class="i">wa</span> <span class="o">-</span> <span class="n">1</span>) <span class="k">do</span>
        <span onmouseout="hideTip(event, 'fs3', 267)" onmouseover="showTip(event, 'fs3', 267)" class="i">As</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 268)" onmouseover="showTip(event, 'fs3', 268)" class="i">ty</span>, <span onmouseout="hideTip(event, 'fs3', 269)" onmouseover="showTip(event, 'fs3', 269)" class="i">tx</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 270)" onmouseover="showTip(event, 'fs3', 270)" class="i">matA</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 271)" onmouseover="showTip(event, 'fs3', 271)" class="i">by</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 272)" onmouseover="showTip(event, 'fs3', 272)" class="i">BLOCK_SIZE</span>, <span onmouseout="hideTip(event, 'fs3', 273)" onmouseover="showTip(event, 'fs3', 273)" class="i">aCol</span>]
        <span onmouseout="hideTip(event, 'fs3', 274)" onmouseover="showTip(event, 'fs3', 274)" class="i">Bs</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 275)" onmouseover="showTip(event, 'fs3', 275)" class="i">ty</span>, <span onmouseout="hideTip(event, 'fs3', 276)" onmouseover="showTip(event, 'fs3', 276)" class="i">tx</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 277)" onmouseover="showTip(event, 'fs3', 277)" class="i">matB</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 278)" onmouseover="showTip(event, 'fs3', 278)" class="v">bRow</span>, <span onmouseout="hideTip(event, 'fs3', 279)" onmouseover="showTip(event, 'fs3', 279)" class="i">bCol</span>]
        <span onmouseout="hideTip(event, 'fs3', 280)" onmouseover="showTip(event, 'fs3', 280)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 281)" onmouseover="showTip(event, 'fs3', 281)" class="i">Barrier</span>(<span onmouseout="hideTip(event, 'fs3', 282)" onmouseover="showTip(event, 'fs3', 282)" class="i">CLK_LOCAL_MEM_FENCE</span>)
 
        <span class="k">for</span> <span onmouseout="hideTip(event, 'fs17', 283)" onmouseover="showTip(event, 'fs17', 283)" class="i">k</span> <span class="o">=</span> <span class="n">0</span> <span class="k">to</span> <span onmouseout="hideTip(event, 'fs3', 284)" onmouseover="showTip(event, 'fs3', 284)" class="i">BLOCK_SIZE</span> <span class="o">-</span> <span class="n">1</span> <span class="k">do</span>
            <span onmouseout="hideTip(event, 'fs3', 285)" onmouseover="showTip(event, 'fs3', 285)" class="v">Csub</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 286)" onmouseover="showTip(event, 'fs3', 286)" class="v">Csub</span> <span class="o">+</span> (<span onmouseout="hideTip(event, 'fs3', 287)" onmouseover="showTip(event, 'fs3', 287)" class="i">As</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 288)" onmouseover="showTip(event, 'fs3', 288)" class="i">ty</span>,<span onmouseout="hideTip(event, 'fs17', 289)" onmouseover="showTip(event, 'fs17', 289)" class="i">k</span>] <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 290)" onmouseover="showTip(event, 'fs3', 290)" class="i">Bs</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs17', 291)" onmouseover="showTip(event, 'fs17', 291)" class="i">k</span>,<span onmouseout="hideTip(event, 'fs3', 292)" onmouseover="showTip(event, 'fs3', 292)" class="i">tx</span>])
        <span onmouseout="hideTip(event, 'fs3', 293)" onmouseover="showTip(event, 'fs3', 293)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 294)" onmouseover="showTip(event, 'fs3', 294)" class="i">Barrier</span>(<span onmouseout="hideTip(event, 'fs3', 295)" onmouseover="showTip(event, 'fs3', 295)" class="i">CLK_LOCAL_MEM_FENCE</span>)

        <span onmouseout="hideTip(event, 'fs3', 296)" onmouseover="showTip(event, 'fs3', 296)" class="v">bRow</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 297)" onmouseover="showTip(event, 'fs3', 297)" class="v">bRow</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 298)" onmouseover="showTip(event, 'fs3', 298)" class="i">bStep</span>
    <span onmouseout="hideTip(event, 'fs3', 299)" onmouseover="showTip(event, 'fs3', 299)" class="i">matC</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 300)" onmouseover="showTip(event, 'fs3', 300)" class="i">by</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 301)" onmouseover="showTip(event, 'fs3', 301)" class="i">BLOCK_SIZE</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 302)" onmouseover="showTip(event, 'fs3', 302)" class="i">ty</span>, <span onmouseout="hideTip(event, 'fs3', 303)" onmouseover="showTip(event, 'fs3', 303)" class="i">bx</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs3', 304)" onmouseover="showTip(event, 'fs3', 304)" class="i">BLOCK_SIZE</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs3', 305)" onmouseover="showTip(event, 'fs3', 305)" class="i">tx</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 306)" onmouseover="showTip(event, 'fs3', 306)" class="v">Csub</span>
</pre>
</td>
</tr>
</table>

<p>The attribute <code>AddressSpace</code> is only one of the many provided by FSCL to add meta-information to kernels and kernel parameters.
For additional information about them, see <a href="dynamicMetadataTutorial.html">Dynamic Metadata Tutorial</a>.</p>

<h3><a name="High-level-constructs-example-Vector-Addition-with-return-type" class="anchor" href="#High-level-constructs-example-Vector-Addition-with-return-type">High-level constructs example: Vector Addition with return type</a></h3>

<p>While enabling to code "classic" OpenCL kernels in F#, FSCL gives the chance to employ additional .NET/F# programming
constructs and data-types that are generally not supported in OpenCL.</p>

<p>The most important, especially from the <a href="http://nuget.org/FSCL.Runtime">kernel composition</a> point of view, is the 
ability for and FSCL kernel to return a value.
In OpenCL, kernels are forced to return <em>void</em>, which is a constrain respected in all the previous examples. 
Nevertheless, the FSCL compiler is able to transform kernel returning non-void values into legal OpenCL kernels, replacing the returned
variable (it must be a variable) with an additional kernel parameter whose purpose is to be a container for the output data.</p>

<p>We can exploit this feature and rewrite our first example. The following code shows the two versions of the vector addition kernel, semantically equivalent, 
where the second is employing the FSCL kernel-return-types feature.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="c">// Classic OpenCL vector addition</span>
[&lt;<span onmouseout="hideTip(event, 'fs3', 307)" onmouseover="showTip(event, 'fs3', 307)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 308)" onmouseover="showTip(event, 'fs3', 308)" class="f">VectorAddNoReturn</span>(<span onmouseout="hideTip(event, 'fs5', 309)" onmouseover="showTip(event, 'fs5', 309)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 310)" onmouseover="showTip(event, 'fs3', 310)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 311)" onmouseover="showTip(event, 'fs6', 311)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 312)" onmouseover="showTip(event, 'fs3', 312)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 313)" onmouseover="showTip(event, 'fs7', 313)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 314)" onmouseover="showTip(event, 'fs3', 314)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 315)" onmouseover="showTip(event, 'fs3', 315)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 316)" onmouseover="showTip(event, 'fs3', 316)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 317)" onmouseover="showTip(event, 'fs3', 317)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 318)" onmouseover="showTip(event, 'fs3', 318)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 319)" onmouseover="showTip(event, 'fs8', 319)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs7', 320)" onmouseover="showTip(event, 'fs7', 320)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 321)" onmouseover="showTip(event, 'fs3', 321)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs5', 322)" onmouseover="showTip(event, 'fs5', 322)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 323)" onmouseover="showTip(event, 'fs3', 323)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs6', 324)" onmouseover="showTip(event, 'fs6', 324)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 325)" onmouseover="showTip(event, 'fs3', 325)" class="i">myId</span>]

<span class="c">// Vector addition with return type</span>
[&lt;<span onmouseout="hideTip(event, 'fs3', 326)" onmouseover="showTip(event, 'fs3', 326)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 327)" onmouseover="showTip(event, 'fs3', 327)" class="f">VectorAddWithReturn</span>(<span onmouseout="hideTip(event, 'fs5', 328)" onmouseover="showTip(event, 'fs5', 328)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 329)" onmouseover="showTip(event, 'fs3', 329)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 330)" onmouseover="showTip(event, 'fs6', 330)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 331)" onmouseover="showTip(event, 'fs3', 331)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 332)" onmouseover="showTip(event, 'fs3', 332)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 333)" onmouseover="showTip(event, 'fs3', 333)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 334)" onmouseover="showTip(event, 'fs7', 334)" class="i">c</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 335)" onmouseover="showTip(event, 'fs3', 335)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 336)" onmouseover="showTip(event, 'fs19', 336)" class="f">zeroCreate</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 337)" onmouseover="showTip(event, 'fs3', 337)" class="t">float32</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs5', 338)" onmouseover="showTip(event, 'fs5', 338)" class="i">a</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 339)" onmouseover="showTip(event, 'fs20', 339)" class="i">Length</span>

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 340)" onmouseover="showTip(event, 'fs3', 340)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 341)" onmouseover="showTip(event, 'fs3', 341)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 342)" onmouseover="showTip(event, 'fs8', 342)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs7', 343)" onmouseover="showTip(event, 'fs7', 343)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 344)" onmouseover="showTip(event, 'fs3', 344)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs5', 345)" onmouseover="showTip(event, 'fs5', 345)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 346)" onmouseover="showTip(event, 'fs3', 346)" class="i">myId</span>] <span class="o">+</span> <span onmouseout="hideTip(event, 'fs6', 347)" onmouseover="showTip(event, 'fs6', 347)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 348)" onmouseover="showTip(event, 'fs3', 348)" class="i">myId</span>]

    <span onmouseout="hideTip(event, 'fs7', 349)" onmouseover="showTip(event, 'fs7', 349)" class="i">c</span>
</pre>
</td>
</tr>
</table>

<p>FSCL is supporting other kind of high-level constructs and data-types, such as <em>structs</em>, <em>records</em> and <em>reference cells</em>.
Reference cells are particularly interesting (and expressive) whenever a kernel output is a singleton (1-element) array.
For example, consider a kernel that executes a computation and eventually produces a scalar value as output. Generally,
the task of writing this value to the output buffer is performed by a specific thread (often the first one), so that
the kernel code looks like the following.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 350)" onmouseover="showTip(event, 'fs3', 350)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 351)" onmouseover="showTip(event, 'fs3', 351)" class="f">MyKernelWithArray</span>(<span onmouseout="hideTip(event, 'fs3', 352)" onmouseover="showTip(event, 'fs3', 352)" class="i">input</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 353)" onmouseover="showTip(event, 'fs3', 353)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 354)" onmouseover="showTip(event, 'fs3', 354)" class="i">output</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 355)" onmouseover="showTip(event, 'fs3', 355)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 356)" onmouseover="showTip(event, 'fs3', 356)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 357)" onmouseover="showTip(event, 'fs3', 357)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 358)" onmouseover="showTip(event, 'fs3', 358)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 359)" onmouseover="showTip(event, 'fs3', 359)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 360)" onmouseover="showTip(event, 'fs8', 360)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 361)" onmouseover="showTip(event, 'fs3', 361)" class="v">resultToWrite</span> <span class="o">=</span> <span class="n">0.0f</span>
    <span class="c">// Do some calculation and compute resultToWrite</span>
    <span class="c">// ...</span>

    <span class="c">// If I&#39;m the first thread then write to the output</span>
    <span class="k">if</span> <span onmouseout="hideTip(event, 'fs3', 362)" onmouseover="showTip(event, 'fs3', 362)" class="i">myId</span> <span class="o">=</span> <span class="n">0</span> <span class="k">then</span>
        <span onmouseout="hideTip(event, 'fs3', 363)" onmouseover="showTip(event, 'fs3', 363)" class="i">output</span><span class="o">.</span>[<span class="n">0</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 364)" onmouseover="showTip(event, 'fs3', 364)" class="v">resultToWrite</span> 
</pre>
</td>
</tr>
</table>

<p>In such a case, you can use a reference cell in place of the output array, as shown below.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 365)" onmouseover="showTip(event, 'fs3', 365)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 366)" onmouseover="showTip(event, 'fs3', 366)" class="f">MyKernelWithRefVar</span>(<span onmouseout="hideTip(event, 'fs3', 367)" onmouseover="showTip(event, 'fs3', 367)" class="i">input</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 368)" onmouseover="showTip(event, 'fs3', 368)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 369)" onmouseover="showTip(event, 'fs3', 369)" class="v">output</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 370)" onmouseover="showTip(event, 'fs3', 370)" class="t">float32</span> <span onmouseout="hideTip(event, 'fs3', 371)" onmouseover="showTip(event, 'fs3', 371)" class="t">ref</span>, <span onmouseout="hideTip(event, 'fs3', 372)" onmouseover="showTip(event, 'fs3', 372)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 373)" onmouseover="showTip(event, 'fs3', 373)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 374)" onmouseover="showTip(event, 'fs3', 374)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 375)" onmouseover="showTip(event, 'fs3', 375)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 376)" onmouseover="showTip(event, 'fs8', 376)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs3', 377)" onmouseover="showTip(event, 'fs3', 377)" class="v">resultToWrite</span> <span class="o">=</span> <span class="n">0.0f</span>
    <span class="c">// Do some calculation and compute resultToWrite</span>
    <span class="c">// ...</span>

    <span class="c">// If I&#39;m the first thread then write to the output</span>
    <span class="k">if</span> <span onmouseout="hideTip(event, 'fs3', 378)" onmouseover="showTip(event, 'fs3', 378)" class="i">myId</span> <span class="o">=</span> <span class="n">0</span> <span class="k">then</span>
        <span onmouseout="hideTip(event, 'fs3', 379)" onmouseover="showTip(event, 'fs3', 379)" class="v">output</span> <span class="o">:=</span> <span onmouseout="hideTip(event, 'fs3', 380)" onmouseover="showTip(event, 'fs3', 380)" class="v">resultToWrite</span> 
</pre>
</td>
</tr>
</table>

<h3><a name="Utility-functions" class="anchor" href="#Utility-functions">Utility functions</a></h3>

<p>When programming a kernel, you're not fored to encapsulate the whole code in a single kernel. Kernels can leverage on 
utility functions to performs some computations or well defined tasks.
For example, in the vector addition sample we may put the operation to be applied to the matching elements of the two input arrays in a separate function.
The OpenCL source produced will contain both the kernel and the utility function definitions.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
[&lt;<span onmouseout="hideTip(event, 'fs3', 381)" onmouseover="showTip(event, 'fs3', 381)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 382)" onmouseover="showTip(event, 'fs3', 382)" class="f">op</span> <span onmouseout="hideTip(event, 'fs21', 383)" onmouseover="showTip(event, 'fs21', 383)" class="i">a</span> <span onmouseout="hideTip(event, 'fs22', 384)" onmouseover="showTip(event, 'fs22', 384)" class="i">b</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs21', 385)" onmouseover="showTip(event, 'fs21', 385)" class="i">a</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs22', 386)" onmouseover="showTip(event, 'fs22', 386)" class="i">b</span>

[&lt;<span onmouseout="hideTip(event, 'fs3', 387)" onmouseover="showTip(event, 'fs3', 387)" class="t">ReflectedDefinition</span>&gt;]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 388)" onmouseover="showTip(event, 'fs3', 388)" class="f">VectorAddWithUtilityFunction</span>(<span onmouseout="hideTip(event, 'fs5', 389)" onmouseover="showTip(event, 'fs5', 389)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 390)" onmouseover="showTip(event, 'fs3', 390)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 391)" onmouseover="showTip(event, 'fs6', 391)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 392)" onmouseover="showTip(event, 'fs3', 392)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 393)" onmouseover="showTip(event, 'fs7', 393)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 394)" onmouseover="showTip(event, 'fs3', 394)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 395)" onmouseover="showTip(event, 'fs3', 395)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 396)" onmouseover="showTip(event, 'fs3', 396)" class="t">WorkItemInfo</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 397)" onmouseover="showTip(event, 'fs3', 397)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 398)" onmouseover="showTip(event, 'fs3', 398)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 399)" onmouseover="showTip(event, 'fs8', 399)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs7', 400)" onmouseover="showTip(event, 'fs7', 400)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 401)" onmouseover="showTip(event, 'fs3', 401)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 402)" onmouseover="showTip(event, 'fs3', 402)" class="f">op</span> <span onmouseout="hideTip(event, 'fs5', 403)" onmouseover="showTip(event, 'fs5', 403)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 404)" onmouseover="showTip(event, 'fs3', 404)" class="i">myId</span>] <span onmouseout="hideTip(event, 'fs6', 405)" onmouseover="showTip(event, 'fs6', 405)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 406)" onmouseover="showTip(event, 'fs3', 406)" class="i">myId</span>]
</pre>
</td>
</tr>
</table>

<h3><a name="FSCL-kernels-as-lambdas" class="anchor" href="#FSCL-kernels-as-lambdas">FSCL kernels as lambdas</a></h3>

<p>FSCL kernels can be also expressed using the lambdas. For example, instad of defining a function, we may write the vector addition kernel as follows.
While the FSCL Compiler is still able to produce the appropriate kernel code in such a case, this time the name of the kernel in the OpenCL source produced
is automatically generated (it is no more <em>VectorAdd</em> ).</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">fun</span> (<span onmouseout="hideTip(event, 'fs5', 407)" onmouseover="showTip(event, 'fs5', 407)" class="i">a</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 408)" onmouseover="showTip(event, 'fs3', 408)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs6', 409)" onmouseover="showTip(event, 'fs6', 409)" class="i">b</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 410)" onmouseover="showTip(event, 'fs3', 410)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs7', 411)" onmouseover="showTip(event, 'fs7', 411)" class="i">c</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs3', 412)" onmouseover="showTip(event, 'fs3', 412)" class="t">float32</span>[], <span onmouseout="hideTip(event, 'fs3', 413)" onmouseover="showTip(event, 'fs3', 413)" class="i">wi</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs3', 414)" onmouseover="showTip(event, 'fs3', 414)" class="t">WorkItemInfo</span>) <span class="k">-&gt;</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 415)" onmouseover="showTip(event, 'fs3', 415)" class="i">myId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 416)" onmouseover="showTip(event, 'fs3', 416)" class="i">wi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 417)" onmouseover="showTip(event, 'fs8', 417)" class="f">GlobalID</span>(<span class="n">0</span>)
    <span onmouseout="hideTip(event, 'fs7', 418)" onmouseover="showTip(event, 'fs7', 418)" class="i">c</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 419)" onmouseover="showTip(event, 'fs3', 419)" class="i">myId</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs3', 420)" onmouseover="showTip(event, 'fs3', 420)" class="f">op</span> <span onmouseout="hideTip(event, 'fs5', 421)" onmouseover="showTip(event, 'fs5', 421)" class="i">a</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 422)" onmouseover="showTip(event, 'fs3', 422)" class="i">myId</span>] <span onmouseout="hideTip(event, 'fs6', 423)" onmouseover="showTip(event, 'fs6', 423)" class="i">b</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs3', 424)" onmouseover="showTip(event, 'fs3', 424)" class="i">myId</span>]
</pre>
</td>
</tr>
</table>

<h3><a name="Using-collection-functions" class="anchor" href="#Using-collection-functions">Using collection functions</a></h3>

<p>In addition to custom FSCL kernels, programmers can compile to OpenCL references and calls to <code>Array</code> collection functions, such as <code>Array.sum</code>, <code>Array.map2</code> and <code>Array.reduce</code>. 
In such a case, the kernel code is not specified by the programmer but produced automatically by the compiler given the intrinsic semantic of those functions. 
For more information about the kernel source produced from collection functions, see <a href="compilerInterfaceTutorial.html">Compiler Interface Tutorial</a>.</p>

<div class="tip" id="fs1">namespace FSCL</div>
<div class="tip" id="fs2">namespace FSCL.Compiler</div>
<div class="tip" id="fs3"></div>
<div class="tip" id="fs4">module Language<br /><br />from FSCL</div>
<div class="tip" id="fs5">val a : float32 []</div>
<div class="tip" id="fs6">val b : float32 []</div>
<div class="tip" id="fs7">val c : float32 []</div>
<div class="tip" id="fs8">abstract member WorkItemInfo.GlobalID : int -&gt; int</div>
<div class="tip" id="fs9">val x : int</div>
<div class="tip" id="fs10">val y : int</div>
<div class="tip" id="fs11">abstract member WorkItemInfo.GlobalSize : int -&gt; int</div>
<div class="tip" id="fs12">static member float4.hypot : a:float4 * b:float4 -&gt; float4</div>
<div class="tip" id="fs13">abstract member WorkItemInfo.GroupID : int -&gt; int</div>
<div class="tip" id="fs14">abstract member WorkItemInfo.LocalID : int -&gt; int</div>
<div class="tip" id="fs15">System.Array.GetLength(dimension: int) : int</div>
<div class="tip" id="fs16">val zeroCreate : length1:int -&gt; length2:int -&gt; &#39;T [,]<br /><br />Full name: Microsoft.FSharp.Collections.Array2D.zeroCreate</div>
<div class="tip" id="fs17">val k : int</div>
<div class="tip" id="fs18">AddressSpace.Local: AddressSpace = 4</div>
<div class="tip" id="fs19">val zeroCreate : count:int -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.zeroCreate</div>
<div class="tip" id="fs20">property System.Array.Length: int</div>
<div class="tip" id="fs21">val a : float32</div>
<div class="tip" id="fs22">val b : float32</div>

        </section>
        <footer>
            <p>This project is maintained by <a href="http://github.com/FSCL">Gabriele Cocco</a></p>
        </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
</body>
</html>